<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>æ‰«ç å†™å…¥AIè¡¨æ ¼</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; padding: 15px; background: #f5f5f5; color: #333; }
    .container { max-width: 500px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    h1 { text-align: center; color: #1890ff; font-size: 1.5rem; margin-bottom: 20px; }
    .status-card { margin: 15px 0; padding: 12px; border-radius: 6px; font-size: 0.9rem; line-height: 1.6; }
    .status-normal { border-left: 4px solid #1890ff; background: #f0f7ff; }
    .status-success { border-left: 4px solid #52c41a; background: #f6ffed; }
    .status-warning { border-left: 4px solid #faad14; background: #fffbe6; }
    .status-error { border-left: 4px solid #ff4d4f; background: #fff2f0; }
    button { width: 100%; padding: 12px; font-size: 1rem; border: none; border-radius: 6px; color: white; margin: 8px 0; cursor: pointer; }
    button.primary { background: #1890ff; }
    button.success { background: #52c41a; }
    button.test { background: #722ed1; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    .log-container { margin-top: 15px; }
    .log-title { font-weight: bold; margin-bottom: 8px; font-size: 0.9rem; }
    .log { background: #f0f0f0; padding: 10px; border-radius: 6px; font-size: 0.8rem; height: 200px; overflow-y: auto; font-family: monospace; white-space: pre-wrap; }
    .tips { font-size: 0.8rem; color: #666; margin-top: 5px; text-align: center; }
  </style>
</head>
<body>
  <div class="container">
    <h1>æ‰«ç å†™å…¥AIè¡¨æ ¼</h1>
    
    <!-- åˆå§‹åŒ–çŠ¶æ€å¡ç‰‡ -->
    <div class="status-card status-normal" id="initStatus">
      ğŸ”„ åˆå§‹åŒ–ä¸­...
    </div>
    
    <!-- æ‰«ç åŒºåŸŸ -->
    <button id="scanBtn" class="primary" disabled>
      ğŸ“· æ‰«æäºŒç»´ç 
    </button>
    <div id="scanResult" class="status-card" style="display: none;"></div>
    
    <!-- å†™å…¥æŒ‰é’® -->
    <button id="writeTableBtn" class="success" disabled>
      ğŸ“Š å†™å…¥AIè¡¨æ ¼
    </button>
    <div class="tips">æç¤ºï¼šæ‰«ç åå¯ç‚¹å‡»å†™å…¥</div>
    
    <!-- æµ‹è¯•æŒ‰é’®ï¼ˆæ–°å¢POSTæµ‹è¯•ï¼‰ -->
    <button id="testPostBtn" class="test">
      ğŸ§ª æµ‹è¯•POSTè¿æ¥
    </button>
    
    <!-- æ—¥å¿—åŒºåŸŸ -->
    <div class="log-container">
      <div class="log-title">æ“ä½œæ—¥å¿—ï¼ˆç‚¹å‡»å¯å¤åˆ¶ï¼‰</div>
      <div class="log" id="log" onclick="copyLog()">
        <!-- æ—¥å¿—å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ -->
      </div>
    </div>
  </div>

  <script src="https://g.alicdn.com/dingding/dingtalk-jsapi/2.13.42/dingtalk.open.js"></script>

  <script>
    let scanData = null;
    let userId = null;
    let corpId = null;
    const BACKEND_URL = 'https://get-config-nltlezcizh.cn-hangzhou.fcapp.run'; // æ›¿æ¢ä¸ºä½ çš„åç«¯åœ°å€

    // æ—¥å¿—å·¥å…·
    function log(msg) {
      const logEl = document.getElementById('log');
      const time = new Date().toLocaleTimeString();
      const line = `[${time}] ${msg}\n`;
      logEl.textContent += line;
      logEl.scrollTop = logEl.scrollHeight;
      console.log(line);
    }

    // å¤åˆ¶æ—¥å¿—
    function copyLog() {
      const logEl = document.getElementById('log');
      dd.device.notification.confirm({
        message: `æ˜¯å¦å¤åˆ¶æ—¥å¿—ï¼Ÿï¼ˆå…±${logEl.textContent.length}å­—ç¬¦ï¼‰`,
        title: 'æç¤º',
        buttonLabels: ['å–æ¶ˆ', 'å¤åˆ¶'],
        onSuccess: function(result) {
          if (result.buttonIndex === 1) {
            const textarea = document.createElement('textarea');
            textarea.value = logEl.textContent;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            dd.device.notification.alert({ message: 'æ—¥å¿—å·²å¤åˆ¶', title: 'æˆåŠŸ' });
          }
        }
      });
    }

    // JSONPè·å–é…ç½®
    function callBackendWithJsonp() {
      return new Promise((resolve, reject) => {
        const callbackName = 'jsonp_cb_' + Date.now();
        const currentUrl = encodeURIComponent(window.location.href.split('#')[0]);
        const url = `${BACKEND_URL}?url=${currentUrl}&callback=${callbackName}`;
        
        log(`ğŸ“¤ å‘èµ·JSONPè¯·æ±‚: ${url.slice(0, 50)}...`);
        
        const script = document.createElement('script');
        script.src = url;
        script.onerror = () => reject(new Error('JSONPè¯·æ±‚å¤±è´¥ï¼ˆç½‘ç»œæˆ–è·¨åŸŸï¼‰'));
        
        const timeout = setTimeout(() => {
          reject(new Error('JSONPè¯·æ±‚è¶…æ—¶ï¼ˆ8ç§’ï¼‰'));
          cleanUp();
        }, 8000);
        
        window[callbackName] = function(data) {
          clearTimeout(timeout);
          cleanUp();
          if (data.error) reject(new Error(`åç«¯é”™è¯¯: ${data.error}`));
          else resolve(data);
        };
        
        function cleanUp() {
          document.head.removeChild(script);
          delete window[callbackName];
        }
        
        document.head.appendChild(script);
      });
    }

    // æ­¥éª¤1ï¼šè·å–å…ç™»æˆæƒç 
    function getAuthCode() {
      return new Promise((resolve, reject) => {
        log('ğŸ”‘ å¼€å§‹è·å–å…ç™»æˆæƒç ...');
        dd.runtime.permission.requestAuthCode({
          corpId: corpId,
          onSuccess: function(res) {
            const authCode = res.code;
            log(`âœ… å…ç™»æˆæƒç è·å–æˆåŠŸ: ${authCode.slice(0, 6)}...`);
            resolve(authCode);
          },
          onFail: function(err) {
            const errMsg = `å…ç™»æˆæƒç å¤±è´¥: ${err.message}ï¼ˆé”™è¯¯ç : ${err.errCode}ï¼‰`;
            log(`âŒ ${errMsg}`);
            reject(new Error(errMsg));
          }
        });
      });
    }

    // æ­¥éª¤2ï¼šå…‘æ¢userIdï¼ˆæ ¸å¿ƒä¿®å¤ï¼‰
    async function exchangeUserId(authCode) {
      log('ğŸ”„ å¼€å§‹å…‘æ¢userId...');
      const exchangeUrl = BACKEND_URL; // ç›´æ¥ä½¿ç”¨åŸºç¡€URLï¼Œé€šè¿‡bodyåŒºåˆ†è¯·æ±‚
      log(`ğŸ“¥ å‘èµ·å…‘æ¢è¯·æ±‚: ${exchangeUrl.slice(0, 50)}...`);

      try {
        // æ·»åŠ è¶…æ—¶æ§åˆ¶ï¼ˆ10ç§’ï¼‰
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000);

        const response = await fetch(exchangeUrl, {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest' // å…¼å®¹éƒ¨åˆ†æœåŠ¡å™¨çš„è·¨åŸŸæ ¡éªŒ
          },
          body: JSON.stringify({ 
            action: 'exchange-userid',
            authCode: authCode 
          }),
          credentials: 'omit',
          signal: controller.signal // å…³è”è¶…æ—¶
        });

        clearTimeout(timeoutId); // æ¸…é™¤è¶…æ—¶

        // å¤„ç†HTTPé”™è¯¯çŠ¶æ€
        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`å…‘æ¢æ¥å£é”™è¯¯ [${response.status}]: ${errorText.slice(0, 100)}`);
        }

        // è§£æå“åº”
        const data = await response.json();
        if (!data.success || !data.userId) {
          throw new Error(`userIdå…‘æ¢å¤±è´¥: ${data.error || 'æœªçŸ¥é”™è¯¯'}`);
        }

        userId = data.userId;
        log(`âœ… å…‘æ¢åˆ°userId: ${userId.slice(0, 6)}...`);
        return userId;

      } catch (error) {
        // è¯¦ç»†é”™è¯¯åˆ†ç±»
        let errMsg;
        if (error.name === 'AbortError') {
          errMsg = 'å…‘æ¢è¯·æ±‚è¶…æ—¶ï¼ˆ10ç§’æœªå“åº”ï¼‰ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ';
        } else if (error.message.includes('Failed to fetch')) {
          errMsg = 'å…‘æ¢è¯·æ±‚å¤±è´¥ï¼ˆç½‘ç»œé”™è¯¯æˆ–è·¨åŸŸé…ç½®é—®é¢˜ï¼‰ï¼Œè¯·ç¡®è®¤åç«¯å…è®¸POSTè¯·æ±‚';
        } else {
          errMsg = error.message;
        }
        log(`âŒ å…‘æ¢userIdå¤±è´¥: ${errMsg}`);
        throw new Error(errMsg);
      }
    }

    // å†™å…¥AIè¡¨æ ¼
    async function writeToAiTable(tableData) {
      if (!userId) throw new Error('æœªè·å–åˆ°ç”¨æˆ·æ ‡è¯†');
      if (!scanData) throw new Error('è¯·å…ˆæ‰«ç ');
      
      try {
        const fullUrl = `${BACKEND_URL}?operatorId=${encodeURIComponent(userId)}`;
        log(`ğŸ“¥ å‘èµ·å†™å…¥è¯·æ±‚: ${fullUrl.slice(0, 50)}...`);
        
        const response = await fetch(fullUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ tableData }),
          credentials: 'omit'
        });
        
        const responseText = await response.text();
        log(`ğŸ“¥ å†™å…¥å“åº” [${response.status}]: ${responseText.slice(0, 100)}`);
        
        if (!response.ok) throw new Error(`æœåŠ¡å™¨é”™è¯¯ [${response.status}]: ${responseText.slice(0, 50)}`);
        
        const result = JSON.parse(responseText);
        if (!result.success) throw new Error(`å†™å…¥å¤±è´¥: ${result.error}`);
        
        return result;
      } catch (error) {
        log(`âš ï¸ å†™å…¥å‡ºé”™: ${error.message}`);
        throw error;
      }
    }

    // åˆå§‹åŒ–æµç¨‹
    async function init() {
      const initStatus = document.getElementById('initStatus');
      initStatus.textContent = 'ğŸ”„ åˆå§‹åŒ–ä¸­...';
      
      try {
        // è·å–é…ç½®
        initStatus.textContent = 'ğŸ”„ è·å–é’‰é’‰é…ç½®...';
        const dingConfig = await callBackendWithJsonp();
        corpId = dingConfig.corpId;
        log(`âœ… é…ç½®è·å–æˆåŠŸ: corpId=${dingConfig.corpId.slice(0,6)}..., å«signature: ${!!dingConfig.signature}`);
        
        // åˆå§‹åŒ–JSAPI
        initStatus.textContent = 'ğŸ”„ åˆå§‹åŒ–JSAPI...';
        dd.config({
          agentId: dingConfig.agentId,
          corpId: dingConfig.corpId,
          timeStamp: dingConfig.timeStamp,
          nonceStr: dingConfig.nonceStr,
          signature: dingConfig.signature,
          jsApiList: ['biz.util.scan', 'device.notification.alert', 'device.notification.confirm', 'runtime.permission.requestAuthCode']
        });
        
        // ç­‰å¾…JSAPIå°±ç»ª
        await new Promise((resolve, reject) => {
          dd.ready(() => {
            log('âœ… JSAPIåˆå§‹åŒ–å®Œæˆ');
            resolve();
          });
          dd.error((err) => reject(new Error(`JSAPIå¤±è´¥: é”™è¯¯ç =${err.errorCode}, ä¿¡æ¯=${err.errorMessage}`)));
        });
        
        // å…ç™»æµç¨‹
        initStatus.textContent = 'ğŸ”„ è·å–ç”¨æˆ·æ ‡è¯†...';
        const authCode = await getAuthCode();
        await exchangeUserId(authCode);
        
        // åˆå§‹åŒ–æˆåŠŸ
        initStatus.className = 'status-card status-success';
        initStatus.textContent = 'âœ… åˆå§‹åŒ–å®Œæˆï¼Œå¯æ‰«ç ';
        document.getElementById('scanBtn').disabled = false;
        
      } catch (error) {
        initStatus.className = 'status-card status-error';
        initStatus.textContent = `âŒ åˆå§‹åŒ–å¤±è´¥: ${error.message}`;
        log(`âŒ åˆå§‹åŒ–æ€»é”™è¯¯: ${error.message}`);
        dd.device.notification.alert({ message: `åˆå§‹åŒ–å¤±è´¥: ${error.message}`, title: 'é”™è¯¯' });
      }
    }

    // æŒ‰é’®äº‹ä»¶
    document.addEventListener('DOMContentLoaded', function() {
      log('ğŸ“± é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–');
      init();

      // æ‰«ç æŒ‰é’®
      document.getElementById('scanBtn').addEventListener('click', function() {
        log('ğŸ“² ç‚¹å‡»æ‰«ç ');
        dd.biz.util.scan({
          type: 'qrCode',
          showMenu: true,
          onSuccess: function(data) {
            scanData = data.text.trim();
            const resultEl = document.getElementById('scanResult');
            resultEl.className = 'status-card status-success';
            resultEl.innerHTML = `<strong>æ‰«ç ç»“æœ:</strong><br>${scanData}`;
            resultEl.style.display = 'block';
            document.getElementById('writeTableBtn').disabled = false;
            log(`âœ… æ‰«ç æˆåŠŸï¼Œé•¿åº¦: ${scanData.length}`);
          },
          onFail: function(err) {
            const errMsg = `æ‰«ç å¤±è´¥: ${err.message}ï¼ˆé”™è¯¯ç : ${err.errCode}ï¼‰`;
            log(`âŒ ${errMsg}`);
            dd.device.notification.alert({ message: errMsg, title: 'å¤±è´¥' });
          }
        });
      });

      // å†™å…¥æŒ‰é’®
      document.getElementById('writeTableBtn').addEventListener('click', async function() {
        const btn = this;
        btn.disabled = true;
        btn.textContent = 'â³ å†™å…¥ä¸­...';
        
        try {
          const tableData = {
            scanContent: scanData,
            scanDate: new Date().toLocaleDateString(),
            scanTime: new Date().toLocaleTimeString(),
            scanDateTime: new Date().toISOString(),
            operatorId: userId,
            deviceInfo: `é’‰é’‰APP(${dd.env.platform})`
          };
          
          const result = await writeToAiTable(tableData);
          btn.textContent = 'âœ… å†™å…¥æˆåŠŸ';
          btn.style.background = '#52c41a';
          log(`ğŸ‰ å†™å…¥æˆåŠŸï¼Œè®°å½•ID: ${result.recordId}`);
          dd.device.notification.alert({ message: `å†™å…¥æˆåŠŸï¼è®°å½•ID: ${result.recordId.slice(0,6)}...`, title: 'æˆåŠŸ' });
        } catch (error) {
          btn.textContent = 'âŒ å†™å…¥å¤±è´¥';
          btn.style.background = '#ff4d4f';
          log(`âŒ å†™å…¥å¤±è´¥: ${error.message}`);
          dd.device.notification.alert({ message: `å†™å…¥å¤±è´¥: ${error.message}`, title: 'å¤±è´¥' });
        } finally {
          setTimeout(() => {
            btn.textContent = 'ğŸ“Š å†™å…¥AIè¡¨æ ¼';
            btn.style.background = '';
            btn.disabled = false;
          }, 3000);
        }
      });

      // æ–°å¢POSTæµ‹è¯•æŒ‰é’®ï¼ˆç”¨äºéªŒè¯POSTè¯·æ±‚æ˜¯å¦é€šï¼‰
      document.getElementById('testPostBtn').addEventListener('click', async function() {
        const btn = this;
        btn.disabled = true;
        btn.textContent = 'ğŸ§ª POSTæµ‹è¯•ä¸­...';
        
        try {
          log('ğŸ“¤ å‘èµ·æµ‹è¯•POSTè¯·æ±‚...');
          const response = await fetch(BACKEND_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'test', message: 'post_test' }),
            credentials: 'omit'
          });
          
          const data = await response.json();
          log(`âœ… POSTæµ‹è¯•å“åº”: ${JSON.stringify(data).slice(0, 100)}`);
          dd.device.notification.alert({ message: `POSTæµ‹è¯•æˆåŠŸ: ${data.success}`, title: 'æµ‹è¯•ç»“æœ' });
        } catch (error) {
          log(`âŒ POSTæµ‹è¯•å¤±è´¥: ${error.message}`);
          dd.device.notification.alert({ message: `POSTæµ‹è¯•å¤±è´¥: ${error.message}`, title: 'æµ‹è¯•ç»“æœ' });
        } finally {
          btn.disabled = false;
          btn.textContent = 'ğŸ§ª æµ‹è¯•POSTè¿æ¥';
        }
      });
    });
  </script>
</body>
</html>
