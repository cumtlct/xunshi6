<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>二维码扫描 & AI表格写入</title>
  <style>
    /* 样式与之前一致，省略重复代码 */
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; padding: 20px; background: #f5f5f5; color: #333; line-height: 1.5; }
    .container { max-width: 600px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    h1 { text-align: center; color: #1890ff; margin-bottom: 20px; }
    .status-card { margin: 20px 0; padding: 15px; border-left: 4px solid #1890ff; border-radius: 6px; background: #f9f9f9; }
    .status-card.success { border-left-color: #52c41a; background: #f6ffed; }
    .status-card.error { border-left-color: #ff4d4f; background: #fff2f0; }
    button { width: 100%; padding: 14px; font-size: 18px; border: none; border-radius: 6px; cursor: pointer; margin: 10px 0; color: white; }
    button.success { background: #52c41a; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    .log { margin-top: 20px; padding: 15px; background: #f0f0f0; font-family: 'Courier New', monospace; white-space: pre-wrap; border-radius: 6px; max-height: 300px; overflow-y: auto; font-size: 14px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>二维码扫描 & AI表格写入</h1>
    <div class="status-card" id="initStatus">🔄 初始化中...</div>
    <button id="scanBtn" disabled>📷 扫描二维码</button>
    <div id="scanResult" class="status-card" style="display:none;"></div>
    <button id="writeTableBtn" disabled class="success">📊 写入 AI 表格</button>
    <button id="testJsonpBtn" style="background: #722ed1;">🧪 JSONP测试后端</button>
    <div><strong>操作日志</strong></div>
    <div class="log" id="log"></div>
  </div>

  <script src="https://g.alicdn.com/dingding/dingtalk-jsapi/2.13.42/dingtalk.open.js"></script>
  <script>
    // 全局变量：新增operatorId（操作人unionId）存储
    let scanData = null;
    let operatorId = null; // 关键：存储当前用户unionId
    const BACKEND_URL = 'https://get-config-nltlezcizh.cn-hangzhou.fcapp.run';

    // 日志工具函数
    function log(msg) {
      const line = `[${new Date().toLocaleTimeString()}] ${msg}`;
      document.getElementById('log').textContent += line + '\n';
      document.getElementById('log').scrollTop = document.getElementById('log').scrollHeight;
      console.log(line);
    }

    // 1. JSONP获取钉钉配置（不变）
    function callBackendWithJsonp() {
      return new Promise((resolve, reject) => {
        const callbackName = 'jsonp_callback_' + Date.now();
        const currentUrl = encodeURIComponent(window.location.href.split('#')[0]);
        const requestUrl = `${BACKEND_URL}?url=${currentUrl}&callback=${callbackName}`;
        
        log(`📤 JSONP请求: ${requestUrl}`);
        const script = document.createElement('script');
        script.src = requestUrl;
        
        const timeoutTimer = setTimeout(() => {
          reject(new Error('JSONP请求超时'));
          cleanUp();
        }, 10000);

        window[callbackName] = function(data) {
          clearTimeout(timeoutTimer);
          cleanUp();
          data.error ? reject(new Error(`后端错误: ${data.message}`)) : resolve(data);
        };

        script.onerror = () => { reject(new Error('JSONP加载失败')); cleanUp(); };
        function cleanUp() { document.head.removeChild(script); delete window[callbackName]; }
        document.head.appendChild(script);
      });
    }

    // 2. 关键修正：获取当前用户unionId（operatorId）
    function getCurrentUserUnionId() {
      return new Promise((resolve, reject) => {
        log('🔍 开始获取当前用户信息（获取unionId）');
        dd.biz.user.get({
          onSuccess: function(userInfo) {
            // 从钉钉API获取unionId（官方推荐唯一标识）
            if (userInfo.unionid) {
              operatorId = userInfo.unionid;
              log(`✅ 获取用户unionId成功: ${operatorId}`);
              resolve(operatorId);
            } else {
              reject(new Error('用户信息中无unionId，请检查微应用权限'));
            }
          },
          onFail: function(err) {
            reject(new Error(`获取用户信息失败: ${err.message}`));
          }
        });
      });
    }

    // 3. 关键修正：POST请求携带operatorId
    async function writeToAiTable(tableData) {
      if (!operatorId) throw new Error('未获取到操作人信息（operatorId缺失）');
      
      try {
        log(`📥 写入数据: ${JSON.stringify(tableData)}, operatorId: ${operatorId}`);
        const response = await fetch(
          // 拼接operatorId到Query参数（官方必选）
          `${BACKEND_URL}?operatorId=${encodeURIComponent(operatorId)}`,
          {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ tableData }),
            credentials: 'omit'
          }
        );

        const responseText = await response.text();
        if (!response.ok) throw new Error(`HTTP ${response.status}: ${responseText.slice(0, 200)}`);
        
        let result = JSON.parse(responseText);
        if (!result.success) throw new Error(`业务错误: ${result.error}`);
        return result;
      } catch (error) {
        log(`⚠️ 写入失败: ${error.message}`);
        throw error;
      }
    }

    // 4. 初始化：新增用户信息获取步骤
    async function initDingtalkConfig() {
      const initStatusEl = document.getElementById('initStatus');
      try {
        // 步骤1：获取钉钉配置
        const dingConfig = await callBackendWithJsonp();
        // 步骤2：初始化钉钉JSAPI（新增user.get权限）
        dd.config({
          agentId: dingConfig.agentId,
          corpId: dingConfig.corpId,
          timeStamp: dingConfig.timeStamp,
          nonceStr: dingConfig.nonceStr,
          signature: dingConfig.signature,
          jsApiList: [
            'biz.util.scan', 
            'device.notification.alert',
            'biz.user.get' // 关键：新增获取用户信息的JSAPI权限
          ]
        });

        dd.ready(async () => {
          try {
            // 步骤3：获取当前用户unionId（初始化时提前获取，避免写入时缺失）
            await getCurrentUserUnionId();
            initStatusEl.className = 'status-card success';
            initStatusEl.innerHTML = '✅ 钉钉环境正常<br>✅ 用户信息已获取<br>✅ 扫码功能就绪';
            document.getElementById('scanBtn').disabled = false;
          } catch (userErr) {
            initStatusEl.className = 'status-card error';
            initStatusEl.innerHTML = `⚠️ 初始化警告<br>原因: ${userErr.message}<br>（仍可扫码，但无法写入表格）`;
            document.getElementById('scanBtn').disabled = false;
          }
        });

        dd.error((err) => {
          initStatusEl.className = 'status-card error';
          initStatusEl.innerHTML = `❌ 钉钉初始化失败: ${JSON.stringify(err).slice(0, 150)}`;
        });
      } catch (error) {
        initStatusEl.className = 'status-card error';
        initStatusEl.innerHTML = `❌ 初始化失败: ${error.message}`;
      }
    }

    // 页面加载 & 按钮事件（扫码、写入逻辑不变，仅写入时携带tableData）
    document.addEventListener('DOMContentLoaded', function() {
      log('📄 页面加载完成');
      initDingtalkConfig();

      // 扫码按钮
      document.getElementById('scanBtn').addEventListener('click', function() {
        dd.biz.util.scan({
          type: 'qrCode',
          onSuccess: (data) => {
            scanData = data.text.trim();
            const resultEl = document.getElementById('scanResult');
            resultEl.className = 'status-card success';
            resultEl.innerHTML = `<strong>扫码结果：</strong><br>${scanData}`;
            resultEl.style.display = 'block';
            document.getElementById('writeTableBtn').disabled = false;
          },
          onFail: (err) => alert(`扫码失败：${err.message}`)
        });
      });

      // 写入按钮
      document.getElementById('writeTableBtn').addEventListener('click', async function() {
        if (!scanData) { alert('请先扫描二维码！'); return; }
        const btn = this;
        btn.disabled = true;
        btn.textContent = '⏳ 写入中...';

        try {
          const tableData = {
            scanContent: scanData,
            scanDate: new Date().toLocaleDateString(),
            scanTime: new Date().toLocaleTimeString(),
            scanDateTime: new Date().toISOString(),
            operator: '钉钉用户',
            deviceInfo: navigator.userAgent.slice(0, 100)
          };
          const result = await writeToAiTable(tableData);
          btn.textContent = '✅ 写入成功';
          btn.style.background = '#52c41a';
          dd.device.notification.alert({
            message: `✅ 写入成功！记录ID：${result.recordId}`,
            title: '成功',
            buttonName: '确定'
          });
        } catch (error) {
          btn.textContent = '❌ 写入失败';
          btn.style.background = '#ff4d4f';
          dd.device.notification.alert({
            message: `❌ 写入失败：${error.message}`,
            title: '失败',
            buttonName: '确定'
          });
        } finally {
          setTimeout(() => {
            btn.textContent = '📊 写入 AI 表格';
            btn.style.background = '';
            btn.disabled = false;
          }, 3000);
        }
      });

      // JSONP测试按钮（不变）
      document.getElementById('testJsonpBtn').addEventListener('click', async function() {
        this.disabled = true;
        this.textContent = '🧪 测试中...';
        try {
          const data = await callBackendWithJsonp();
          alert(`✅ 测试成功：\ncorpId=${data.corpId}\nagentId=${data.agentId}`);
        } catch (err) {
          alert(`❌ 测试失败：${err.message}`);
        } finally {
          this.disabled = false;
          this.textContent = '🧪 JSONP测试后端';
        }
      });
    });
  </script>
</body>
</html>
