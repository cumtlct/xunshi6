<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>扫码入库（连接流版）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <!-- 钉钉 JSAPI -->
  <script src="https://g.alicdn.com/dingding/dingtalk-jsapi/2.10.1/dingtalk.open.js"></script>
  <style>
    body { font-family: PingFang SC, Helvetica, Arial; padding: 20px; }
    h2   { margin-top: 0; }
    #log  { background: #f5f5f5; padding: 10px; border-radius: 4px; white-space: pre-wrap; word-break: break-all; }
    .btn { display: block; width: 100%; line-height: 44px; margin: 15px 0; background: #0078ff; color: #fff; text-align: center; border: none; border-radius: 4px; font-size: 16px; }
    .btn:active { background: #005fd1; }
  </style>
</head>
<body>
  <h2>钉钉扫码 → 直连连接流</h2>
  <button class="btn" id="scanBtn">开始扫码</button>
  <div id="log"></div>

  <script>
    /* ===== 1. 唯一需要改的地址：连接流 Webhook ===== */
    const FLOW_HOOK = 'https://connector.dingtalk.com/webhook/flow/0747829f52ccf0469457ffc2';   // ← 换成你自己的

    /* ===== 2. 日志输出 ===== */
    const $log = document.getElementById('log');
    function log(msg) {
      $log.textContent += `[${new Date().toLocaleTimeString()}] ${msg}\n`;
      console.log(msg);
    }

    /* ===== 3. 初始化钉钉 JSAPI ===== */
    log('页面加载完成，开始初始化钉钉配置...');
    dd.ready(() => {
      log('钉钉 JSAPI 初始化成功');
      document.getElementById('scanBtn').addEventListener('click', scanCode);
    });
    dd.error(err => log(`JSAPI 异常: ${JSON.stringify(err)}`));

    /* ===== 4. 扫码 → 直发连接流 ===== */
    async function scanCode() {
      try {
        log('调用扫码...');
        const res = await dd.biz.util.scan({ type: 'qr' });
        if (!res.text) {
          log('扫码取消');
          return;
        }
        log(`扫码成功: ${res.text}`);

        /* 组装连接流需要的数据 */
        const body = {
          scanResult: res.text,
          userId: await getUserId(),                 // 当前用户
          deviceId: dd.device.platform || 'unknown',
          scanTime: new Date().toLocaleString('zh-CN', { hourCycle: 'h23' })
        };

        log('提交连接流 Webhook...');
        const rsp = await fetch(FLOW_HOOK, {
          method : 'POST',
          headers: { 'Content-Type': 'application/json' },
          body   : JSON.stringify(body)
        });
        const json = await rsp.json();

        if (json.success) {
          log(`✅ 已写入多维表，recordId: ${json.recordId}`);
          dd.alert({ title: '成功', content: `扫码内容已入库！\nrecordId: ${json.recordId}` });
        } else {
          log(`❌ 写入失败: ${JSON.stringify(json)}`);
          dd.alert({ title: '失败', content: `入库失败\n${JSON.stringify(json)}` });
        }
      } catch (e) {
        log(`扫码或提交异常: ${e.message}`);
        dd.alert({ title: '出错', content: e.message });
      }
    }

    /* ===== 5. 拿当前用户 ID ===== */
    async function getUserId() {
      return new Promise((resolve) => {
        dd.runtime.permission.requestAuthCode({
          corpId: ding7e9dde4f5cecba404ac5d6980864d335,          // 替换成你的真实 corpId，也可从 JSAPI 签名接口带回
          onSuccess: info => resolve(info.code), // 这里简化用 authCode 当标识
          onFail   : err => resolve('unknown')
        });
      });
    }
  </script>
</body>
</html>
