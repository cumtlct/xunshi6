<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>æ‰«ç å†™å…¥AIè¡¨æ ¼</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; padding: 15px; background: #f5f5f5; color: #333; }
    .container { max-width: 500px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    h1 { text-align: center; color: #1890ff; font-size: 1.5rem; margin-bottom: 20px; }
    .status-card { margin: 15px 0; padding: 12px; border-radius: 6px; font-size: 0.9rem; line-height: 1.6; }
    .status-normal { border-left: 4px solid #1890ff; background: #f0f7ff; }
    .status-success { border-left: 4px solid #52c41a; background: #f6ffed; }
    .status-warning { border-left: 4px solid #faad14; background: #fffbe6; }
    .status-error { border-left: 4px solid #ff4d4f; background: #fff2f0; }
    button { width: 100%; padding: 12px; font-size: 1rem; border: none; border-radius: 6px; color: white; margin: 8px 0; cursor: pointer; }
    button.primary { background: #1890ff; }
    button.success { background: #52c41a; }
    button.test { background: #722ed1; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    .log-container { margin-top: 15px; }
    .log-title { font-weight: bold; margin-bottom: 8px; font-size: 0.9rem; }
    .log { background: #f0f0f0; padding: 10px; border-radius: 6px; font-size: 0.8rem; height: 200px; overflow-y: auto; font-family: monospace; white-space: pre-wrap; }
    .tips { font-size: 0.8rem; color: #666; margin-top: 5px; text-align: center; }
  </style>
</head>
<body>
  <div class="container">
    <h1>æ‰«ç å†™å…¥AIè¡¨æ ¼</h1>
    
    <!-- åˆå§‹åŒ–çŠ¶æ€å¡ç‰‡ -->
    <div class="status-card status-normal" id="initStatus">
      ğŸ”„ åˆå§‹åŒ–ä¸­...
    </div>
    
    <!-- æ‰«ç åŒºåŸŸ -->
    <button id="scanBtn" class="primary" disabled>
      ğŸ“· æ‰«æäºŒç»´ç 
    </button>
    <div id="scanResult" class="status-card" style="display: none;"></div>
    
    <!-- å†™å…¥æŒ‰é’® -->
    <button id="writeTableBtn" class="success" disabled>
      ğŸ“Š å†™å…¥AIè¡¨æ ¼
    </button>
    <div class="tips">æç¤ºï¼šæ‰«ç åå¯ç‚¹å‡»å†™å…¥</div>
    
    <!-- æµ‹è¯•æŒ‰é’® -->
    <button id="testJsonpBtn" class="test">
      ğŸ§ª æµ‹è¯•åç«¯è¿æ¥
    </button>
    
    <!-- æ—¥å¿—åŒºåŸŸï¼ˆæ‰‹æœºç«¯è°ƒè¯•æ ¸å¿ƒï¼‰ -->
    <div class="log-container">
      <div class="log-title">æ“ä½œæ—¥å¿—ï¼ˆç‚¹å‡»å¯å¤åˆ¶ï¼‰</div>
      <div class="log" id="log" onclick="copyLog()">
        <!-- æ—¥å¿—å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ -->
      </div>
    </div>
  </div>

  <!-- é’‰é’‰JSAPI -->
  <script src="https://g.alicdn.com/dingding/dingtalk-jsapi/2.13.42/dingtalk.open.js"></script>

  <script>
    // å…¨å±€å˜é‡
    let scanData = null;
    let userId = null; // æœ€ç»ˆä½¿ç”¨userIdä½œä¸ºoperatorId
    let corpId = null; // ä»JSONPé…ç½®ä¸­è·å–ä¼ä¸šID
    const BACKEND_URL = 'https://get-config-nltlezcizh.cn-hangzhou.fcapp.run'; // æ›¿æ¢ä¸ºä½ çš„åç«¯åœ°å€

    // ==============================
    // 1. æ—¥å¿—å·¥å…·ï¼ˆæ‰‹æœºç«¯å¯è§†åŒ–ï¼‰
    // ==============================
    function log(msg) {
      const logEl = document.getElementById('log');
      const time = new Date().toLocaleTimeString(); // åªæ˜¾ç¤ºæ—¶é—´ï¼ˆèŠ‚çœç©ºé—´ï¼‰
      const line = `[${time}] ${msg}\n`;
      logEl.textContent += line;
      logEl.scrollTop = logEl.scrollHeight; // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
      console.log(line); // åŒæ—¶è¾“å‡ºåˆ°è°ƒè¯•å·¥å…·ï¼ˆè‹¥æœ‰ï¼‰
    }

    // å¤åˆ¶æ—¥å¿—åˆ°å‰ªè´´æ¿ï¼ˆæ‰‹æœºç«¯æ–¹ä¾¿åˆ†äº«ï¼‰
    function copyLog() {
      const logEl = document.getElementById('log');
      dd.device.notification.confirm({
        message: `æ˜¯å¦å¤åˆ¶æ—¥å¿—ï¼Ÿï¼ˆå…±${logEl.textContent.length}å­—ç¬¦ï¼‰`,
        title: 'æç¤º',
        buttonLabels: ['å–æ¶ˆ', 'å¤åˆ¶'],
        onSuccess: function(result) {
          if (result.buttonIndex === 1) { // ç‚¹å‡»"å¤åˆ¶"
            const textarea = document.createElement('textarea');
            textarea.value = logEl.textContent;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            dd.device.notification.alert({ message: 'æ—¥å¿—å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', title: 'æˆåŠŸ' });
          }
        }
      });
    }

    // ==============================
    // 2. JSONPè·å–é’‰é’‰é…ç½®ï¼ˆåŸºç¡€åŠŸèƒ½ï¼‰
    // ==============================
    function callBackendWithJsonp() {
      return new Promise((resolve, reject) => {
        const callbackName = 'jsonp_cb_' + Date.now();
        const currentUrl = encodeURIComponent(window.location.href.split('#')[0]);
        const url = `${BACKEND_URL}?url=${currentUrl}&callback=${callbackName}`;
        
        log(`ğŸ“¤ å‘èµ·JSONPè¯·æ±‚: ${url.slice(0, 50)}...`); // æˆªæ–­é•¿URLï¼Œé¿å…æ—¥å¿—è¿‡é•¿
        
        const script = document.createElement('script');
        script.src = url;
        script.onerror = () => reject(new Error('JSONPè¯·æ±‚å¤±è´¥ï¼ˆç½‘ç»œæˆ–è·¨åŸŸé—®é¢˜ï¼‰'));
        
        // è¶…æ—¶å¤„ç†ï¼ˆ8ç§’ï¼Œæ‰‹æœºç½‘ç»œè¾ƒæ…¢ï¼‰
        const timeout = setTimeout(() => {
          reject(new Error('JSONPè¯·æ±‚è¶…æ—¶ï¼ˆ8ç§’æœªå“åº”ï¼‰'));
          cleanUp();
        }, 8000);
        
        // å›è°ƒå‡½æ•°
        window[callbackName] = function(data) {
          clearTimeout(timeout);
          cleanUp();
          if (data.error) reject(new Error(`åç«¯é”™è¯¯: ${data.error}`));
          else resolve(data);
        };
        
        function cleanUp() {
          document.head.removeChild(script);
          delete window[callbackName];
        }
        
        document.head.appendChild(script);
      });
    }

    // ==============================
    // 3. æ ¸å¿ƒï¼šå…ç™»æµç¨‹è·å–userIdï¼ˆé’‰é’‰å®˜æ–¹æ ‡å‡†æ–¹æ¡ˆï¼‰
    // ==============================
    /**
     * æ­¥éª¤1ï¼šè·å–å…ç™»æˆæƒç ï¼ˆauthCodeï¼‰
     */
    function getAuthCode() {
      return new Promise((resolve, reject) => {
        log('ğŸ”‘ å¼€å§‹è·å–å…ç™»æˆæƒç ...');
        dd.runtime.permission.requestAuthCode({
          corpId: corpId, // ä»JSONPé…ç½®ä¸­è·å–ä¼ä¸šID
          onSuccess: function(res) {
            const authCode = res.code;
            log(`âœ… å…ç™»æˆæƒç è·å–æˆåŠŸ: ${authCode.slice(0, 6)}...`);
            resolve(authCode);
          },
          onFail: function(err) {
            const errMsg = `å…ç™»æˆæƒç è·å–å¤±è´¥: ${err.message}ï¼ˆé”™è¯¯ç : ${err.errCode}ï¼‰`;
            log(`âŒ ${errMsg}`);
            reject(new Error(errMsg));
          }
        });
      });
    }

    /**
     * æ­¥éª¤2ï¼šåç«¯å…‘æ¢userId
     */
    async function exchangeUserId(authCode) {
      log('ğŸ”„ å¼€å§‹å…‘æ¢userId...');
      const response = await fetch(`${BACKEND_URL}/exchange-userid`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action: 'exchange-userid', authCode }), // æ˜ç¡®æŒ‡å®šaction
        credentials: 'omit'
      });
      const data = await response.json();
      if (!data.success || !data.userId) {
        throw new Error(`userIdå…‘æ¢å¤±è´¥: ${data.error || 'æœªçŸ¥é”™è¯¯'}`);
      }
      userId = data.userId;
      log(`âœ… å…‘æ¢åˆ°userId: ${userId.slice(0, 6)}...`);
      return userId;
    }

    // ==============================
    // 4. å†™å…¥AIè¡¨æ ¼ï¼ˆç¡®ä¿userIdä¼ é€’ï¼‰
    // ==============================
    async function writeToAiTable(tableData) {
      if (!userId) {
        throw new Error('æœªè·å–åˆ°ç”¨æˆ·æ ‡è¯†ï¼Œæ— æ³•å†™å…¥è¡¨æ ¼');
      }
      if (!scanData) {
        throw new Error('è¯·å…ˆæ‰«æäºŒç»´ç ');
      }
      
      try {
        // æ‹¼æ¥userIdåˆ°è¯·æ±‚å‚æ•°ï¼ˆåç«¯å¿…éœ€ï¼‰
        const fullUrl = `${BACKEND_URL}?operatorId=${encodeURIComponent(userId)}`;
        log(`ğŸ“¥ å‘èµ·å†™å…¥è¯·æ±‚: ${fullUrl.slice(0, 50)}...`);
        
        const response = await fetch(fullUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ tableData }),
          credentials: 'omit' // ç¦ç”¨cookieï¼Œé¿å…è·¨åŸŸé—®é¢˜
        });
        
        // è¯»å–å“åº”å†…å®¹ï¼ˆæ— è®ºæˆåŠŸå¤±è´¥ï¼Œéƒ½æ˜¾ç¤ºåœ¨æ—¥å¿—ï¼‰
        const responseText = await response.text();
        log(`ğŸ“¥ åç«¯å“åº” [${response.status}]: ${responseText.slice(0, 100)}...`);
        
        // å¤„ç†HTTPé”™è¯¯
        if (!response.ok) {
          throw new Error(`æœåŠ¡å™¨é”™è¯¯ [${response.status}]: ${responseText.slice(0, 50)}`);
        }
        
        // è§£æJSONå“åº”
        const result = JSON.parse(responseText);
        if (!result.success) {
          throw new Error(`å†™å…¥å¤±è´¥: ${result.error || 'æœªçŸ¥é”™è¯¯'}`);
        }
        
        return result;
      } catch (error) {
        log(`âš ï¸ å†™å…¥è¿‡ç¨‹å‡ºé”™: ${error.message}`);
        throw error;
      }
    }

    // ==============================
    // 5. åˆå§‹åŒ–æµç¨‹ï¼ˆåˆ†æ­¥éª¤æç¤ºï¼‰
    // ==============================
    async function init() {
      const initStatus = document.getElementById('initStatus');
      initStatus.textContent = 'ğŸ”„ æ­£åœ¨åˆå§‹åŒ–é’‰é’‰ç¯å¢ƒ...';
      
      try {
        // æ­¥éª¤1: è·å–é’‰é’‰é…ç½®ï¼ˆå«corpIdå’Œsignatureï¼‰
        initStatus.textContent = 'ğŸ”„ æ­£åœ¨è·å–é’‰é’‰é…ç½®...';
        const dingConfig = await callBackendWithJsonp();
        corpId = dingConfig.corpId; // ä¿å­˜ä¼ä¸šIDç”¨äºå…ç™»
        log(`âœ… é’‰é’‰é…ç½®è·å–æˆåŠŸ: corpId=${dingConfig.corpId.slice(0, 6)}..., åŒ…å«signature: ${!!dingConfig.signature}`);
        
        // æ­¥éª¤2: åˆå§‹åŒ–JSAPIï¼ˆå¿…é¡»åŒ…å«signatureï¼‰
        initStatus.textContent = 'ğŸ”„ æ­£åœ¨åˆå§‹åŒ–åŸºç¡€åŠŸèƒ½...';
        dd.config({
          agentId: dingConfig.agentId,
          corpId: dingConfig.corpId,
          timeStamp: dingConfig.timeStamp,
          nonceStr: dingConfig.nonceStr,
          signature: dingConfig.signature, // å…³é”®ï¼šä½¿ç”¨åç«¯è¿”å›çš„signature
          jsApiList: [
            'biz.util.scan',          // æ‰«ç 
            'device.notification.alert', // å¼¹çª—
            'device.notification.confirm', // ç¡®è®¤æ¡†
            'runtime.permission.requestAuthCode' // å…ç™»æˆæƒç ï¼ˆæ ¸å¿ƒï¼‰
          ]
        });
        
        // æ­¥éª¤3: ç­‰å¾…JSAPIå°±ç»ª
        await new Promise((resolve, reject) => {
          dd.ready(() => {
            log('âœ… dd.ready å›è°ƒè§¦å‘ï¼ŒJSAPIåˆå§‹åŒ–å®Œæˆ');
            resolve();
          });
          dd.error((err) => {
            const errMsg = `JSAPIåˆå§‹åŒ–å¤±è´¥: é”™è¯¯ç =${err.errorCode}, ä¿¡æ¯=${err.errorMessage}`;
            reject(new Error(errMsg));
          });
        });
        log('âœ… é’‰é’‰JSAPIåˆå§‹åŒ–æˆåŠŸ');
        
        // æ­¥éª¤4: æ‰§è¡Œå…ç™»æµç¨‹ï¼ˆè·å–userIdï¼‰
        initStatus.className = 'status-card status-warning';
        initStatus.textContent = 'ğŸ”„ æ­£åœ¨è·å–ç”¨æˆ·æ ‡è¯†...';
        try {
          const authCode = await getAuthCode();
          await exchangeUserId(authCode);
          initStatus.className = 'status-card status-success';
          initStatus.textContent = 'âœ… åˆå§‹åŒ–å®Œæˆï¼Œå¯æ‰«ç ';
          document.getElementById('scanBtn').disabled = false;
        } catch (authErr) {
          log(`âš ï¸ å…ç™»æµç¨‹å¤±è´¥ï¼ŒåŸå› : ${authErr.message}`);
          initStatus.className = 'status-card status-error';
          initStatus.textContent = `âŒ åˆå§‹åŒ–å¤±è´¥: ${authErr.message}\nï¼ˆè¯·æ£€æŸ¥ç½‘ç»œæˆ–æƒé™ï¼‰`;
          dd.device.notification.alert({
            message: `åˆå§‹åŒ–å¤±è´¥: ${authErr.message}`,
            title: 'é”™è¯¯'
          });
        }
        
      } catch (error) {
        initStatus.className = 'status-card status-error';
        initStatus.textContent = `âŒ åˆå§‹åŒ–å¤±è´¥: ${error.message}`;
        log(`âŒ åˆå§‹åŒ–æ€»é”™è¯¯: ${error.message}`);
        dd.device.notification.alert({
          message: `åˆå§‹åŒ–å¤±è´¥: ${error.message}`,
          title: 'é”™è¯¯'
        });
      }
    }

    // ==============================
    // 6. æŒ‰é’®äº‹ä»¶ï¼ˆæ‰‹æœºç«¯äº¤äº’ï¼‰
    // ==============================
    document.addEventListener('DOMContentLoaded', function() {
      log('ğŸ“± é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–');
      init(); // å¯åŠ¨åˆå§‹åŒ–æµç¨‹

      // æ‰«ç æŒ‰é’®
      document.getElementById('scanBtn').addEventListener('click', function() {
        log('ğŸ“² ç‚¹å‡»æ‰«ç æŒ‰é’®');
        dd.biz.util.scan({
          type: 'qrCode',
          showMenu: true, // æ˜¾ç¤ºå³ä¸Šè§’èœå•ï¼ˆæ‰‹æœºç«¯å®ç”¨ï¼‰
          onSuccess: function(data) {
            scanData = data.text.trim();
            const resultEl = document.getElementById('scanResult');
            resultEl.className = 'status-card status-success';
            resultEl.innerHTML = `<strong>æ‰«ç ç»“æœ:</strong><br>${scanData}<br><small>ï¼ˆå¯ç‚¹å‡»å†™å…¥è¡¨æ ¼ï¼‰</small>`;
            resultEl.style.display = 'block';
            document.getElementById('writeTableBtn').disabled = false;
            log(`âœ… æ‰«ç æˆåŠŸï¼Œå†…å®¹é•¿åº¦: ${scanData.length}`);
          },
          onFail: function(err) {
            const errMsg = `æ‰«ç å¤±è´¥: ${err.message}ï¼ˆé”™è¯¯ç : ${err.errCode}ï¼‰`;
            log(`âŒ ${errMsg}`);
            dd.device.notification.alert({ message: errMsg, title: 'æ‰«ç å¤±è´¥' });
          }
        });
      });

      // å†™å…¥æŒ‰é’®
      document.getElementById('writeTableBtn').addEventListener('click', async function() {
        const btn = this;
        btn.disabled = true;
        btn.textContent = 'â³ å†™å…¥ä¸­...';
        
        try {
          // æ„é€ è¡¨æ ¼æ•°æ®ï¼ˆå­—æ®µåä¸è¡¨æ ¼ä¸¥æ ¼ä¸€è‡´ï¼‰
          const tableData = {
            scanContent: scanData,
            scanDate: new Date().toLocaleDateString(),
            scanTime: new Date().toLocaleTimeString(),
            scanDateTime: new Date().toISOString(),
            operatorId: userId, // æ˜¾å¼å­˜å‚¨ç”¨æˆ·æ ‡è¯†
            deviceInfo: `é’‰é’‰APP(${dd.env.platform})` // ç®€åŒ–è®¾å¤‡ä¿¡æ¯ï¼ˆæ‰‹æœºç«¯å‹å¥½ï¼‰
          };
          
          const result = await writeToAiTable(tableData);
          btn.textContent = 'âœ… å†™å…¥æˆåŠŸ';
          btn.style.background = '#52c41a';
          log(`ğŸ‰ å†™å…¥æˆåŠŸï¼Œè®°å½•ID: ${result.recordId}`);
          dd.device.notification.alert({
            message: `å†™å…¥æˆåŠŸï¼è®°å½•ID: ${result.recordId.slice(0, 6)}...`,
            title: 'æˆåŠŸ'
          });
        } catch (error) {
          btn.textContent = 'âŒ å†™å…¥å¤±è´¥';
          btn.style.background = '#ff4d4f';
          log(`âŒ å†™å…¥å¤±è´¥: ${error.message}`);
          dd.device.notification.alert({
            message: `å†™å…¥å¤±è´¥: ${error.message}`,
            title: 'å¤±è´¥'
          });
        } finally {
          // 3ç§’åæ¢å¤æŒ‰é’®çŠ¶æ€
          setTimeout(() => {
            btn.textContent = 'ğŸ“Š å†™å…¥AIè¡¨æ ¼';
            btn.style.background = '';
            btn.disabled = false;
          }, 3000);
        }
      });

      // æµ‹è¯•æŒ‰é’®
      document.getElementById('testJsonpBtn').addEventListener('click', async function() {
        const btn = this;
        btn.disabled = true;
        btn.textContent = 'ğŸ§ª æµ‹è¯•ä¸­...';
        
        try {
          const data = await callBackendWithJsonp();
          log(`âœ… åç«¯æµ‹è¯•æˆåŠŸ: corpId=${data.corpId.slice(0, 6)}..., åŒ…å«signature: ${!!data.signature}`);
          dd.device.notification.alert({
            message: `æµ‹è¯•æˆåŠŸï¼\ncorpId: ${data.corpId.slice(0, 6)}...\næ˜¯å¦æœ‰signature: ${!!data.signature}`,
            title: 'æµ‹è¯•ç»“æœ'
          });
        } catch (error) {
          log(`âŒ åç«¯æµ‹è¯•å¤±è´¥: ${error.message}`);
          dd.device.notification.alert({
            message: `æµ‹è¯•å¤±è´¥: ${error.message}`,
            title: 'æµ‹è¯•ç»“æœ'
          });
        } finally {
          btn.disabled = false;
          btn.textContent = 'ğŸ§ª æµ‹è¯•åç«¯è¿æ¥';
        }
      });
    });
  </script>
</body>
</html>
