<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>二维码扫描 & AI表格写入</title>
  <!-- 样式保持不变 -->
</head>
<body>
  <div class="container">
    <h1>二维码扫描 & AI表格写入</h1>
    
    <div class="step">
      <strong>步骤 1:</strong> 初始化钉钉环境
    </div>
    <div id="status">正在初始化钉钉环境...</div>
    
    <div class="step">
      <strong>步骤 2:</strong> 扫描二维码
    </div>
    <button id="scanBtn" disabled>扫描二维码</button>
    
    <div class="step">
      <strong>步骤 3:</strong> 写入 AI 表格
    </div>
    <button id="writeTableBtn" disabled class="success">写入 AI 表格</button>
    
    <!-- 其他HTML内容保持不变 -->
  </div>

  <script src="https://g.alicdn.com/dingding/open-develop/4.9.0/dingtalk.js"></script>

  <script>
    // ========== 配置区 ==========
    const BACKEND_URL = 'https://get-config-nltlezcizh.cn-hangzhou.fcapp.run';
    
    // 全局变量
    let scanData = null;
    let ddConfig = null;

    // ========== 工具函数 ==========
    function log(msg) {
      const logEl = document.getElementById('log');
      const line = `[${new Date().toLocaleTimeString()}] ${msg}`;
      logEl.textContent += line + '\n';
      logEl.scrollTop = logEl.scrollHeight;
      console.log(line);
    }

    function updateStatus(msg, isError = false) {
      const statusEl = document.getElementById('status');
      statusEl.textContent = msg;
      statusEl.style.borderLeftColor = isError ? '#ff4d4f' : '#1890ff';
    }

    // ========== 初始化逻辑 ==========
    (async () => {
      try {
        log('🚀 开始初始化流程');

        const currentUrl = window.location.href.split('#')[0];
        const encodedUrl = encodeURIComponent(currentUrl);

        updateStatus('📡 正在请求后端签名配置...');
        const response = await fetch(`${BACKEND_URL}?url=${encodedUrl}`);

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        ddConfig = await response.json();

        if (ddConfig.error) {
          throw new Error('后端返回错误: ' + ddConfig.error);
        }

        // 初始化钉钉JSAPI - 使用正确的权限配置
        dd.config({
          agentId: ddConfig.agentId,
          corpId: ddConfig.corpId,
          timeStamp: ddConfig.timeStamp,
          nonceStr: ddConfig.nonceStr,
          signature: ddConfig.signature,
          jsApiList: [
            'biz.util.scan',  // ✅ 正确的扫码权限
            'runtime.permission.requestAuthCode'
          ]
        });

        dd.ready(() => {
          log('✅ dd.ready() 触发');
          updateStatus('✅ 钉钉环境已就绪，可扫描二维码');
          document.getElementById('scanBtn').disabled = false;
        });

        dd.error((err) => {
          const errMsg = JSON.stringify(err);
          log(`❌ dd.error: ${errMsg}`);
          updateStatus(`❌ 钉钉初始化失败: ${errMsg}`, true);
        });

      } catch (err) {
        const msg = `💥 初始化流程失败: ${err.message}`;
        log(msg);
        updateStatus(msg, true);
      }
    })();

    // ========== 扫描按钮事件 ==========
    document.getElementById('scanBtn').addEventListener('click', () => {
      log('📲 用户点击"扫描二维码"');
      updateStatus('📷 请扫描二维码...');
      
      // 使用正确的扫码API
      dd.biz.util.scan({
        type: "qrCode", // 二维码
        onSuccess: function(data) {
          log('✅ 扫码成功: ' + data.text);
          
          // 处理扫码数据
          try {
            // 尝试解析JSON格式
            const parsedData = JSON.parse(data.text);
            scanData = parsedData;
          } catch (e) {
            // 如果不是JSON，作为纯文本处理
            scanData = { content: data.text };
          }
          
          // 启用写入按钮
          document.getElementById('writeTableBtn').disabled = false;
          updateStatus('✅ 扫码成功！点击"写入 AI 表格"保存数据');
        },
        onFail: function(err) {
          log(`❌ 扫码失败: ${JSON.stringify(err)}`);
          updateStatus('❌ 扫码失败，请重试', true);
        }
      });
    });

    // ========== 写入表格按钮事件 ==========
    document.getElementById('writeTableBtn').addEventListener('click', async () => {
      if (!scanData) {
        updateStatus('❌ 请先扫描二维码！', true);
        return;
      }
      
      const writeBtn = document.getElementById('writeTableBtn');
      writeBtn.disabled = true;
      writeBtn.textContent = '写入中...';
      
      updateStatus('📤 正在写入AI表格...');
      
      try {
        // 准备数据
        const now = new Date();
        const tableData = {
          scanContent: scanData.content || JSON.stringify(scanData),
          scanDate: now.toISOString().split('T')[0],
          scanTime: now.toTimeString().split(' ')[0],
          scanDateTime: now.toISOString(),
          operator: dd.env.userName || '未知用户'
        };
        
        // 发送到后端
        const response = await fetch(BACKEND_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            tableData: tableData
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          updateStatus('✅ 数据已成功写入AI表格！');
          writeBtn.textContent = '✅ 已写入AI表格';
          writeBtn.style.background = '#52c41a';
        } else {
          throw new Error(result.error || '写入失败');
        }
      } catch (error) {
        updateStatus(`❌ 写入失败: ${error.message}`, true);
        writeBtn.disabled = false;
        writeBtn.textContent = '写入 AI 表格';
      }
    });
  </script>
</body>
</html>
