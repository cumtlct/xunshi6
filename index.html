<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>扫码录入多维表</title>
  <!-- 钉钉 JSAPI -->
  <script src="https://g.alicdn.com/dingding/dingtalk-jsapi/2.20.0/dingtalk.open.js"></script>
  <style>
    body{font-family:PingFang SC;text-align:center;padding:40px;background:#f5f5f5}
    h3{margin-bottom:30px}
    button{height:48px;padding:0 32px;font-size:18px;color:#fff;background:#1677ff;border:0;border-radius:6px;cursor:pointer}
    button:disabled{background:#91caff;cursor:not-allowed}
    #status{margin-top:20px;font-size:15px;color:#666}
    .success{color:#52c41a!important}
    .error{color:#ff4d4f!important}
  </style>
</head>
<body>
  <h3>扫码自动录入多维表</h3>
  <button id="scanBtn">开始扫码</button>
  <div id="status">等待扫码…</div>

  <script>
    /* ==========  ① 改成你的 FC 免登接口  ========== */
    const USER_API    = 'https://get-config-nltlezcizh.cn-hangzhou.fcapp.run';   // FC 触发器地址
    /* ==========  ② 改成你的连接流 Webhook  ========== */
    const WEBHOOK_URL = 'https://connector.dingtalk.com/webhook/flow/0747829f52ccf0469457ffc2';
    /* ==========  ③ Token（没有就留空）  ========== */
    const TOKEN       = '';

    const $ = id => document.getElementById(id);
    const status = (txt, col = '#666') => {
      $('status').innerText = txt;
      $('status').className = col === '#52c41a' ? 'success' : (col === '#ff4d4f' ? 'error' : '');
    };

    /* 扫码 → 免登 → 连接流 */
    async function submitData(codeContent) {
      const now = new Date();
      const body = {
        content : codeContent,
        scanTime: `${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2,0)}-${now.getDate().toString().padStart(2,0)} ${now.getHours().toString().padStart(2,0)}:${now.getMinutes().toString().padStart(2,0)}:${now.getSeconds().toString().padStart(2,0)}`,
        scanDate: `${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2,0)}-${now.getDate().toString().padStart(2,0)}`,
        userId   : '',
        userName : ''
      };

      // 1. 免登拿 code
      status('正在获取用户信息…');
      const authCode = await new Promise((resolve, reject) =>
        dd.runtime.permission.requestAuthCode({
          corpId: _config.corpId,
          onSuccess: res => resolve(res.code),
          onFail   : err => reject(err)
        })
      );

      // 2. 用 code 换 userid / name
      const userResp = await fetch(`${USER_API}?code=${authCode}`);
      const user     = await userResp.json();
      if (!user.userid) throw new Error(user.msg || '免登失败');
      body.userId   = user.userid;
      body.userName = user.name;

      // 3. 发送到连接流
      status('正在提交…');
      const rsp = await fetch(WEBHOOK_URL, {
        method : 'POST',
        headers: { 'Content-Type': 'application/json', ...(TOKEN ? {Token: TOKEN} : {}) },
        body   : JSON.stringify(body)
      });
      const json = await rsp.json();
      if (json.success) {
        status('录入成功！', '#52c41a');
        setTimeout(() => status('等待扫码…'), 2000);
      } else {
        throw new Error(json.message || '提交失败');
      }
    }

    /* 按钮事件 */
    $('scanBtn').addEventListener('click', async () => {
      const btn = $('scanBtn');
      btn.disabled = true;
      try {
        const code = await new Promise((resolve, reject) =>
          dd.biz.util.scan({ type: 'qrCode', onSuccess: res => resolve(res.text), onFail: err => reject(err) })
        );
        status(`扫码结果：${code}`);
        await submitData(code);
      } catch (e) {
        status(e.message || '用户取消或失败', '#ff4d4f');
      } finally {
        btn.disabled = false;
      }
    });

    dd.ready(() => console.log('JSAPI ready'));
    dd.error(err => console.error('JSAPI error', err));
  </script>
</body>
</html>
