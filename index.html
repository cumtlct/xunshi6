<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>äºŒç»´ç æ‰«æ & AIè¡¨æ ¼å†™å…¥</title>
  <style>
    /* æ ·å¼ä¸ä¹‹å‰ä¸€è‡´ï¼Œçœç•¥é‡å¤ä»£ç  */
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; padding: 20px; background: #f5f5f5; color: #333; line-height: 1.5; }
    .container { max-width: 600px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    h1 { text-align: center; color: #1890ff; margin-bottom: 20px; }
    .status-card { margin: 20px 0; padding: 15px; border-left: 4px solid #1890ff; border-radius: 6px; background: #f9f9f9; }
    .status-card.success { border-left-color: #52c41a; background: #f6ffed; }
    .status-card.error { border-left-color: #ff4d4f; background: #fff2f0; }
    button { width: 100%; padding: 14px; font-size: 18px; border: none; border-radius: 6px; cursor: pointer; margin: 10px 0; color: white; }
    button.success { background: #52c41a; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    .log { margin-top: 20px; padding: 15px; background: #f0f0f0; font-family: 'Courier New', monospace; white-space: pre-wrap; border-radius: 6px; max-height: 300px; overflow-y: auto; font-size: 14px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>äºŒç»´ç æ‰«æ & AIè¡¨æ ¼å†™å…¥</h1>
    <div class="status-card" id="initStatus">ğŸ”„ åˆå§‹åŒ–ä¸­...</div>
    <button id="scanBtn" disabled>ğŸ“· æ‰«æäºŒç»´ç </button>
    <div id="scanResult" class="status-card" style="display:none;"></div>
    <button id="writeTableBtn" disabled class="success">ğŸ“Š å†™å…¥ AI è¡¨æ ¼</button>
    <button id="testJsonpBtn" style="background: #722ed1;">ğŸ§ª JSONPæµ‹è¯•åç«¯</button>
    <div><strong>æ“ä½œæ—¥å¿—</strong></div>
    <div class="log" id="log"></div>
  </div>

  <script src="https://g.alicdn.com/dingding/dingtalk-jsapi/2.13.42/dingtalk.open.js"></script>
  <script>
    // å…¨å±€å˜é‡ï¼šæ–°å¢operatorIdï¼ˆæ“ä½œäººunionIdï¼‰å­˜å‚¨
    let scanData = null;
    let operatorId = null; // å…³é”®ï¼šå­˜å‚¨å½“å‰ç”¨æˆ·unionId
    const BACKEND_URL = 'https://get-config-nltlezcizh.cn-hangzhou.fcapp.run';

    // æ—¥å¿—å·¥å…·å‡½æ•°
    function log(msg) {
      const line = `[${new Date().toLocaleTimeString()}] ${msg}`;
      document.getElementById('log').textContent += line + '\n';
      document.getElementById('log').scrollTop = document.getElementById('log').scrollHeight;
      console.log(line);
    }

    // 1. JSONPè·å–é’‰é’‰é…ç½®ï¼ˆä¸å˜ï¼‰
    function callBackendWithJsonp() {
      return new Promise((resolve, reject) => {
        const callbackName = 'jsonp_callback_' + Date.now();
        const currentUrl = encodeURIComponent(window.location.href.split('#')[0]);
        const requestUrl = `${BACKEND_URL}?url=${currentUrl}&callback=${callbackName}`;
        
        log(`ğŸ“¤ JSONPè¯·æ±‚: ${requestUrl}`);
        const script = document.createElement('script');
        script.src = requestUrl;
        
        const timeoutTimer = setTimeout(() => {
          reject(new Error('JSONPè¯·æ±‚è¶…æ—¶'));
          cleanUp();
        }, 10000);

        window[callbackName] = function(data) {
          clearTimeout(timeoutTimer);
          cleanUp();
          data.error ? reject(new Error(`åç«¯é”™è¯¯: ${data.message}`)) : resolve(data);
        };

        script.onerror = () => { reject(new Error('JSONPåŠ è½½å¤±è´¥')); cleanUp(); };
        function cleanUp() { document.head.removeChild(script); delete window[callbackName]; }
        document.head.appendChild(script);
      });
    }

    // 2. å…³é”®ä¿®æ­£ï¼šè·å–å½“å‰ç”¨æˆ·unionIdï¼ˆoperatorIdï¼‰
    function getCurrentUserUnionId() {
      return new Promise((resolve, reject) => {
        log('ğŸ” å¼€å§‹è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯ï¼ˆè·å–unionIdï¼‰');
        dd.biz.user.get({
          onSuccess: function(userInfo) {
            // ä»é’‰é’‰APIè·å–unionIdï¼ˆå®˜æ–¹æ¨èå”¯ä¸€æ ‡è¯†ï¼‰
            if (userInfo.unionid) {
              operatorId = userInfo.unionid;
              log(`âœ… è·å–ç”¨æˆ·unionIdæˆåŠŸ: ${operatorId}`);
              resolve(operatorId);
            } else {
              reject(new Error('ç”¨æˆ·ä¿¡æ¯ä¸­æ— unionIdï¼Œè¯·æ£€æŸ¥å¾®åº”ç”¨æƒé™'));
            }
          },
          onFail: function(err) {
            reject(new Error(`è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥: ${err.message}`));
          }
        });
      });
    }

    // 3. å…³é”®ä¿®æ­£ï¼šPOSTè¯·æ±‚æºå¸¦operatorId
    async function writeToAiTable(tableData) {
      if (!operatorId) throw new Error('æœªè·å–åˆ°æ“ä½œäººä¿¡æ¯ï¼ˆoperatorIdç¼ºå¤±ï¼‰');
      
      try {
        log(`ğŸ“¥ å†™å…¥æ•°æ®: ${JSON.stringify(tableData)}, operatorId: ${operatorId}`);
        const response = await fetch(
          // æ‹¼æ¥operatorIdåˆ°Queryå‚æ•°ï¼ˆå®˜æ–¹å¿…é€‰ï¼‰
          `${BACKEND_URL}?operatorId=${encodeURIComponent(operatorId)}`,
          {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ tableData }),
            credentials: 'omit'
          }
        );

        const responseText = await response.text();
        if (!response.ok) throw new Error(`HTTP ${response.status}: ${responseText.slice(0, 200)}`);
        
        let result = JSON.parse(responseText);
        if (!result.success) throw new Error(`ä¸šåŠ¡é”™è¯¯: ${result.error}`);
        return result;
      } catch (error) {
        log(`âš ï¸ å†™å…¥å¤±è´¥: ${error.message}`);
        throw error;
      }
    }

    // 4. åˆå§‹åŒ–ï¼šæ–°å¢ç”¨æˆ·ä¿¡æ¯è·å–æ­¥éª¤
    async function initDingtalkConfig() {
      const initStatusEl = document.getElementById('initStatus');
      try {
        // æ­¥éª¤1ï¼šè·å–é’‰é’‰é…ç½®
        const dingConfig = await callBackendWithJsonp();
        // æ­¥éª¤2ï¼šåˆå§‹åŒ–é’‰é’‰JSAPIï¼ˆæ–°å¢user.getæƒé™ï¼‰
        dd.config({
          agentId: dingConfig.agentId,
          corpId: dingConfig.corpId,
          timeStamp: dingConfig.timeStamp,
          nonceStr: dingConfig.nonceStr,
          signature: dingConfig.signature,
          jsApiList: [
            'biz.util.scan', 
            'device.notification.alert',
            'biz.user.get' // å…³é”®ï¼šæ–°å¢è·å–ç”¨æˆ·ä¿¡æ¯çš„JSAPIæƒé™
          ]
        });

        dd.ready(async () => {
          try {
            // æ­¥éª¤3ï¼šè·å–å½“å‰ç”¨æˆ·unionIdï¼ˆåˆå§‹åŒ–æ—¶æå‰è·å–ï¼Œé¿å…å†™å…¥æ—¶ç¼ºå¤±ï¼‰
            await getCurrentUserUnionId();
            initStatusEl.className = 'status-card success';
            initStatusEl.innerHTML = 'âœ… é’‰é’‰ç¯å¢ƒæ­£å¸¸<br>âœ… ç”¨æˆ·ä¿¡æ¯å·²è·å–<br>âœ… æ‰«ç åŠŸèƒ½å°±ç»ª';
            document.getElementById('scanBtn').disabled = false;
          } catch (userErr) {
            initStatusEl.className = 'status-card error';
            initStatusEl.innerHTML = `âš ï¸ åˆå§‹åŒ–è­¦å‘Š<br>åŸå› : ${userErr.message}<br>ï¼ˆä»å¯æ‰«ç ï¼Œä½†æ— æ³•å†™å…¥è¡¨æ ¼ï¼‰`;
            document.getElementById('scanBtn').disabled = false;
          }
        });

        dd.error((err) => {
          initStatusEl.className = 'status-card error';
          initStatusEl.innerHTML = `âŒ é’‰é’‰åˆå§‹åŒ–å¤±è´¥: ${JSON.stringify(err).slice(0, 150)}`;
        });
      } catch (error) {
        initStatusEl.className = 'status-card error';
        initStatusEl.innerHTML = `âŒ åˆå§‹åŒ–å¤±è´¥: ${error.message}`;
      }
    }

    // é¡µé¢åŠ è½½ & æŒ‰é’®äº‹ä»¶ï¼ˆæ‰«ç ã€å†™å…¥é€»è¾‘ä¸å˜ï¼Œä»…å†™å…¥æ—¶æºå¸¦tableDataï¼‰
    document.addEventListener('DOMContentLoaded', function() {
      log('ğŸ“„ é¡µé¢åŠ è½½å®Œæˆ');
      initDingtalkConfig();

      // æ‰«ç æŒ‰é’®
      document.getElementById('scanBtn').addEventListener('click', function() {
        dd.biz.util.scan({
          type: 'qrCode',
          onSuccess: (data) => {
            scanData = data.text.trim();
            const resultEl = document.getElementById('scanResult');
            resultEl.className = 'status-card success';
            resultEl.innerHTML = `<strong>æ‰«ç ç»“æœï¼š</strong><br>${scanData}`;
            resultEl.style.display = 'block';
            document.getElementById('writeTableBtn').disabled = false;
          },
          onFail: (err) => alert(`æ‰«ç å¤±è´¥ï¼š${err.message}`)
        });
      });

      // å†™å…¥æŒ‰é’®
      document.getElementById('writeTableBtn').addEventListener('click', async function() {
        if (!scanData) { alert('è¯·å…ˆæ‰«æäºŒç»´ç ï¼'); return; }
        const btn = this;
        btn.disabled = true;
        btn.textContent = 'â³ å†™å…¥ä¸­...';

        try {
          const tableData = {
            scanContent: scanData,
            scanDate: new Date().toLocaleDateString(),
            scanTime: new Date().toLocaleTimeString(),
            scanDateTime: new Date().toISOString(),
            operator: 'é’‰é’‰ç”¨æˆ·',
            deviceInfo: navigator.userAgent.slice(0, 100)
          };
          const result = await writeToAiTable(tableData);
          btn.textContent = 'âœ… å†™å…¥æˆåŠŸ';
          btn.style.background = '#52c41a';
          dd.device.notification.alert({
            message: `âœ… å†™å…¥æˆåŠŸï¼è®°å½•IDï¼š${result.recordId}`,
            title: 'æˆåŠŸ',
            buttonName: 'ç¡®å®š'
          });
        } catch (error) {
          btn.textContent = 'âŒ å†™å…¥å¤±è´¥';
          btn.style.background = '#ff4d4f';
          dd.device.notification.alert({
            message: `âŒ å†™å…¥å¤±è´¥ï¼š${error.message}`,
            title: 'å¤±è´¥',
            buttonName: 'ç¡®å®š'
          });
        } finally {
          setTimeout(() => {
            btn.textContent = 'ğŸ“Š å†™å…¥ AI è¡¨æ ¼';
            btn.style.background = '';
            btn.disabled = false;
          }, 3000);
        }
      });

      // JSONPæµ‹è¯•æŒ‰é’®ï¼ˆä¸å˜ï¼‰
      document.getElementById('testJsonpBtn').addEventListener('click', async function() {
        this.disabled = true;
        this.textContent = 'ğŸ§ª æµ‹è¯•ä¸­...';
        try {
          const data = await callBackendWithJsonp();
          alert(`âœ… æµ‹è¯•æˆåŠŸï¼š\ncorpId=${data.corpId}\nagentId=${data.agentId}`);
        } catch (err) {
          alert(`âŒ æµ‹è¯•å¤±è´¥ï¼š${err.message}`);
        } finally {
          this.disabled = false;
          this.textContent = 'ğŸ§ª JSONPæµ‹è¯•åç«¯';
        }
      });
    });
  </script>
</body>
</html>
