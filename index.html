<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>扫码提交到多维表</title>
  <script src="https://g.alicdn.com/dingding/dingtalk-pc-api/2.10.12/index.js"></script>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto; padding: 20px; }
    button { padding: 12px 24px; font-size: 16px; margin: 10px 0; }
    .btn-primary { background: #1890ff; color: white; border: none; border-radius: 4px; cursor: pointer; }
    .btn-primary:disabled { background: #bfbfbf; cursor: not-allowed; }
    #result { margin-top: 20px; padding: 10px; background: #f5f5f5; border-radius: 4px; }
  </style>
</head>
<body>
  <h2>扫码并提交数据</h2>
  <button id="scanBtn" class="btn-primary">点击扫码</button>
  <div id="result"></div>

  <script>
    let currentUser = null; // 存储当前用户信息

    // 第一步：免登获取用户身份
    function dingtalkAuth() {
      return new Promise((resolve, reject) => {
        const url = encodeURIComponent(window.location.href);
        // 调用钉钉免登接口
        dd.runtime.permission.requestAuthCode({
          corpId: "ding7e9dde4f5cecba404ac5d6980864d335", // 替换为你的企业 corpId（可在管理后台查看）
          onSuccess: function(info) {
            // 用 code 换用户信息（需后端！但钉钉 H5 可用 JSAPI 直接获取部分信息）
            // 实际上，在钉钉容器内，可通过 dd.getEnv 直接拿到用户信息（部分版本支持）
            // 更可靠方式：调用 dd.getUserInfo（需在可信域名下）
            getUserInfo().then(resolve).catch(reject);
          },
          onFail: function(err) {
            console.error('免登失败', err);
            alert('身份验证失败，请在钉钉中打开');
            reject(err);
          }
        });
      });
    }

    // 第二步：获取用户详细信息（姓名、userid）
    function getUserInfo() {
      return new Promise((resolve, reject) => {
        dd.getUserInfo({
          onSuccess: function(res) {
            console.log('用户信息:', res);
            currentUser = {
              userid: res.userid,
              name: res.nick || res.name,
              avatar: res.avatar
            };
            resolve(currentUser);
          },
          onFail: function(err) {
            console.error('获取用户信息失败', err);
            reject(err);
          }
        });
      });
    }

    // 第三步：调用扫码
    function startScan() {
      if (!currentUser) {
        alert('请先完成身份验证');
        return;
      }

      dd.biz.util.scan({
        type: 'all', // 支持 all / qr / bar
        onSuccess: function(data) {
          console.log('扫码结果:', data);
          const scanContent = data.text;

          // 组装最终提交数据
          const payload = {
            content: scanContent,
            scanTime: new Date().toISOString(), // ISO 8601 格式，多维表兼容性最好
            scanDate: new Date().toISOString().split('T')[0],
            operatorName: currentUser.name,
            operatorId: currentUser.userid
          };

          // 显示结果（实际项目中这里调用 submitToWebhook(payload)）
          document.getElementById('result').innerHTML = `
            <p><strong>扫码内容：</strong>${scanContent}</p>
            <p><strong>操作人：</strong>${currentUser.name} (${currentUser.userid})</p>
            <p><strong>时间：</strong>${new Date().toLocaleString()}</p>
            <button class="btn-primary" onclick="submitToWebhook(${JSON.stringify(payload).replace(/'/g, "\\'")})">
              提交到多维表
            </button>
          `;
        },
        onFail: function(err) {
          console.error('扫码失败', err);
          alert('扫码失败：' + (err.message || '未知错误'));
        }
      });
    }

    // 第四步：提交到你已创建的 Webhook 连接流
    function submitToWebhook(payload) {
      const webhookUrl = 'https://connector.dingtalk.com/webhook/flow/0747829f52ccf0469457ffc2'; // ← 替换为你的实际 URL

      // 如果你的连接流设置了 Token 认证，请取消下一行注释并填入 token
      // const token = 'your_token_here';

      fetch(webhookUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          // ...(token ? { 'X-DingTalk-Token': token } : {})
        },
        body: JSON.stringify(payload)
      })
      .then(res => res.json())
      .then(data => {
        if (data.success || data.code === 0) {
          alert('✅ 提交成功！数据已写入多维表');
        } else {
          alert('❌ 提交失败：' + (data.message || JSON.stringify(data)));
        }
      })
      .catch(err => {
        console.error('网络错误:', err);
        alert('网络错误，请检查控制台');
      });
    }

    // 页面加载完成后自动初始化
    document.addEventListener('DOMContentLoaded', function() {
      // 初始化钉钉 JSAPI
      dd.ready(function() {
        console.log('钉钉 JSAPI 已准备就绪');
        // 自动获取用户身份
        dingtalkAuth().catch(err => {
          console.error('初始化失败', err);
        });
      });

      // 绑定扫码按钮
      document.getElementById('scanBtn').addEventListener('click', startScan);
    });
  </script>
</body>
</html>

