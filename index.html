<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>扫码写入AI表格</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; padding: 15px; background: #f5f5f5; color: #333; }
    .container { max-width: 500px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    h1 { text-align: center; color: #1890ff; font-size: 1.5rem; margin-bottom: 20px; }
    .status-card { margin: 15px 0; padding: 12px; border-radius: 6px; font-size: 0.9rem; line-height: 1.6; }
    .status-normal { border-left: 4px solid #1890ff; background: #f0f7ff; }
    .status-success { border-left: 4px solid #52c41a; background: #f6ffed; }
    .status-warning { border-left: 4px solid #faad14; background: #fffbe6; }
    .status-error { border-left: 4px solid #ff4d4f; background: #fff2f0; }
    button { width: 100%; padding: 12px; font-size: 1rem; border: none; border-radius: 6px; color: white; margin: 8px 0; cursor: pointer; }
    button.primary { background: #1890ff; }
    button.success { background: #52c41a; }
    button.test { background: #722ed1; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    .log-container { margin-top: 15px; }
    .log-title { font-weight: bold; margin-bottom: 8px; font-size: 0.9rem; }
    .log { background: #f0f0f0; padding: 10px; border-radius: 6px; font-size: 0.8rem; height: 200px; overflow-y: auto; font-family: monospace; white-space: pre-wrap; }
    .tips { font-size: 0.8rem; color: #666; margin-top: 5px; text-align: center; }
  </style>
</head>
<body>
  <div class="container">
    <h1>扫码写入AI表格</h1>
    
    <!-- 初始化状态卡片 -->
    <div class="status-card status-normal" id="initStatus">
      🔄 初始化中...
    </div>
    
    <!-- 扫码区域 -->
    <button id="scanBtn" class="primary" disabled>
      📷 扫描二维码
    </button>
    <div id="scanResult" class="status-card" style="display: none;"></div>
    
    <!-- 写入按钮 -->
    <button id="writeTableBtn" class="success" disabled>
      📊 写入AI表格
    </button>
    <div class="tips">提示：扫码后可点击写入</div>
    
    <!-- 测试按钮（新增POST测试） -->
    <button id="testPostBtn" class="test">
      🧪 测试POST连接
    </button>
    
    <!-- 日志区域 -->
    <div class="log-container">
      <div class="log-title">操作日志（点击可复制）</div>
      <div class="log" id="log" onclick="copyLog()">
        <!-- 日志将显示在这里 -->
      </div>
    </div>
  </div>

  <script src="https://g.alicdn.com/dingding/dingtalk-jsapi/2.13.42/dingtalk.open.js"></script>

  <script>
    let scanData = null;
    let userId = null;
    let corpId = null;
    const BACKEND_URL = 'https://get-config-nltlezcizh.cn-hangzhou.fcapp.run'; // 替换为你的后端地址

    // 日志工具
    function log(msg) {
      const logEl = document.getElementById('log');
      const time = new Date().toLocaleTimeString();
      const line = `[${time}] ${msg}\n`;
      logEl.textContent += line;
      logEl.scrollTop = logEl.scrollHeight;
      console.log(line);
    }

    // 复制日志
    function copyLog() {
      const logEl = document.getElementById('log');
      dd.device.notification.confirm({
        message: `是否复制日志？（共${logEl.textContent.length}字符）`,
        title: '提示',
        buttonLabels: ['取消', '复制'],
        onSuccess: function(result) {
          if (result.buttonIndex === 1) {
            const textarea = document.createElement('textarea');
            textarea.value = logEl.textContent;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            dd.device.notification.alert({ message: '日志已复制', title: '成功' });
          }
        }
      });
    }

    // JSONP获取配置
    function callBackendWithJsonp() {
      return new Promise((resolve, reject) => {
        const callbackName = 'jsonp_cb_' + Date.now();
        const currentUrl = encodeURIComponent(window.location.href.split('#')[0]);
        const url = `${BACKEND_URL}?url=${currentUrl}&callback=${callbackName}`;
        
        log(`📤 发起JSONP请求: ${url.slice(0, 50)}...`);
        
        const script = document.createElement('script');
        script.src = url;
        script.onerror = () => reject(new Error('JSONP请求失败（网络或跨域）'));
        
        const timeout = setTimeout(() => {
          reject(new Error('JSONP请求超时（8秒）'));
          cleanUp();
        }, 8000);
        
        window[callbackName] = function(data) {
          clearTimeout(timeout);
          cleanUp();
          if (data.error) reject(new Error(`后端错误: ${data.error}`));
          else resolve(data);
        };
        
        function cleanUp() {
          document.head.removeChild(script);
          delete window[callbackName];
        }
        
        document.head.appendChild(script);
      });
    }

    // 步骤1：获取免登授权码
    function getAuthCode() {
      return new Promise((resolve, reject) => {
        log('🔑 开始获取免登授权码...');
        dd.runtime.permission.requestAuthCode({
          corpId: corpId,
          onSuccess: function(res) {
            const authCode = res.code;
            log(`✅ 免登授权码获取成功: ${authCode.slice(0, 6)}...`);
            resolve(authCode);
          },
          onFail: function(err) {
            const errMsg = `免登授权码失败: ${err.message}（错误码: ${err.errCode}）`;
            log(`❌ ${errMsg}`);
            reject(new Error(errMsg));
          }
        });
      });
    }

    // 步骤2：兑换userId（核心修复）
    async function exchangeUserId(authCode) {
      log('🔄 开始兑换userId...');
      const exchangeUrl = BACKEND_URL; // 直接使用基础URL，通过body区分请求
      log(`📥 发起兑换请求: ${exchangeUrl.slice(0, 50)}...`);

      try {
        // 添加超时控制（10秒）
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000);

        const response = await fetch(exchangeUrl, {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest' // 兼容部分服务器的跨域校验
          },
          body: JSON.stringify({ 
            action: 'exchange-userid',
            authCode: authCode 
          }),
          credentials: 'omit',
          signal: controller.signal // 关联超时
        });

        clearTimeout(timeoutId); // 清除超时

        // 处理HTTP错误状态
        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`兑换接口错误 [${response.status}]: ${errorText.slice(0, 100)}`);
        }

        // 解析响应
        const data = await response.json();
        if (!data.success || !data.userId) {
          throw new Error(`userId兑换失败: ${data.error || '未知错误'}`);
        }

        userId = data.userId;
        log(`✅ 兑换到userId: ${userId.slice(0, 6)}...`);
        return userId;

      } catch (error) {
        // 详细错误分类
        let errMsg;
        if (error.name === 'AbortError') {
          errMsg = '兑换请求超时（10秒未响应），请检查网络';
        } else if (error.message.includes('Failed to fetch')) {
          errMsg = '兑换请求失败（网络错误或跨域配置问题），请确认后端允许POST请求';
        } else {
          errMsg = error.message;
        }
        log(`❌ 兑换userId失败: ${errMsg}`);
        throw new Error(errMsg);
      }
    }

    // 写入AI表格
    async function writeToAiTable(tableData) {
      if (!userId) throw new Error('未获取到用户标识');
      if (!scanData) throw new Error('请先扫码');
      
      try {
        const fullUrl = `${BACKEND_URL}?operatorId=${encodeURIComponent(userId)}`;
        log(`📥 发起写入请求: ${fullUrl.slice(0, 50)}...`);
        
        const response = await fetch(fullUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ tableData }),
          credentials: 'omit'
        });
        
        const responseText = await response.text();
        log(`📥 写入响应 [${response.status}]: ${responseText.slice(0, 100)}`);
        
        if (!response.ok) throw new Error(`服务器错误 [${response.status}]: ${responseText.slice(0, 50)}`);
        
        const result = JSON.parse(responseText);
        if (!result.success) throw new Error(`写入失败: ${result.error}`);
        
        return result;
      } catch (error) {
        log(`⚠️ 写入出错: ${error.message}`);
        throw error;
      }
    }

    // 初始化流程
    async function init() {
      const initStatus = document.getElementById('initStatus');
      initStatus.textContent = '🔄 初始化中...';
      
      try {
        // 获取配置
        initStatus.textContent = '🔄 获取钉钉配置...';
        const dingConfig = await callBackendWithJsonp();
        corpId = dingConfig.corpId;
        log(`✅ 配置获取成功: corpId=${dingConfig.corpId.slice(0,6)}..., 含signature: ${!!dingConfig.signature}`);
        
        // 初始化JSAPI
        initStatus.textContent = '🔄 初始化JSAPI...';
        dd.config({
          agentId: dingConfig.agentId,
          corpId: dingConfig.corpId,
          timeStamp: dingConfig.timeStamp,
          nonceStr: dingConfig.nonceStr,
          signature: dingConfig.signature,
          jsApiList: ['biz.util.scan', 'device.notification.alert', 'device.notification.confirm', 'runtime.permission.requestAuthCode']
        });
        
        // 等待JSAPI就绪
        await new Promise((resolve, reject) => {
          dd.ready(() => {
            log('✅ JSAPI初始化完成');
            resolve();
          });
          dd.error((err) => reject(new Error(`JSAPI失败: 错误码=${err.errorCode}, 信息=${err.errorMessage}`)));
        });
        
        // 免登流程
        initStatus.textContent = '🔄 获取用户标识...';
        const authCode = await getAuthCode();
        await exchangeUserId(authCode);
        
        // 初始化成功
        initStatus.className = 'status-card status-success';
        initStatus.textContent = '✅ 初始化完成，可扫码';
        document.getElementById('scanBtn').disabled = false;
        
      } catch (error) {
        initStatus.className = 'status-card status-error';
        initStatus.textContent = `❌ 初始化失败: ${error.message}`;
        log(`❌ 初始化总错误: ${error.message}`);
        dd.device.notification.alert({ message: `初始化失败: ${error.message}`, title: '错误' });
      }
    }

    // 按钮事件
    document.addEventListener('DOMContentLoaded', function() {
      log('📱 页面加载完成，开始初始化');
      init();

      // 扫码按钮
      document.getElementById('scanBtn').addEventListener('click', function() {
        log('📲 点击扫码');
        dd.biz.util.scan({
          type: 'qrCode',
          showMenu: true,
          onSuccess: function(data) {
            scanData = data.text.trim();
            const resultEl = document.getElementById('scanResult');
            resultEl.className = 'status-card status-success';
            resultEl.innerHTML = `<strong>扫码结果:</strong><br>${scanData}`;
            resultEl.style.display = 'block';
            document.getElementById('writeTableBtn').disabled = false;
            log(`✅ 扫码成功，长度: ${scanData.length}`);
          },
          onFail: function(err) {
            const errMsg = `扫码失败: ${err.message}（错误码: ${err.errCode}）`;
            log(`❌ ${errMsg}`);
            dd.device.notification.alert({ message: errMsg, title: '失败' });
          }
        });
      });

      // 写入按钮
      document.getElementById('writeTableBtn').addEventListener('click', async function() {
        const btn = this;
        btn.disabled = true;
        btn.textContent = '⏳ 写入中...';
        
        try {
          const tableData = {
            scanContent: scanData,
            scanDate: new Date().toLocaleDateString(),
            scanTime: new Date().toLocaleTimeString(),
            scanDateTime: new Date().toISOString(),
            operatorId: userId,
            deviceInfo: `钉钉APP(${dd.env.platform})`
          };
          
          const result = await writeToAiTable(tableData);
          btn.textContent = '✅ 写入成功';
          btn.style.background = '#52c41a';
          log(`🎉 写入成功，记录ID: ${result.recordId}`);
          dd.device.notification.alert({ message: `写入成功！记录ID: ${result.recordId.slice(0,6)}...`, title: '成功' });
        } catch (error) {
          btn.textContent = '❌ 写入失败';
          btn.style.background = '#ff4d4f';
          log(`❌ 写入失败: ${error.message}`);
          dd.device.notification.alert({ message: `写入失败: ${error.message}`, title: '失败' });
        } finally {
          setTimeout(() => {
            btn.textContent = '📊 写入AI表格';
            btn.style.background = '';
            btn.disabled = false;
          }, 3000);
        }
      });

      // 新增POST测试按钮（用于验证POST请求是否通）
      document.getElementById('testPostBtn').addEventListener('click', async function() {
        const btn = this;
        btn.disabled = true;
        btn.textContent = '🧪 POST测试中...';
        
        try {
          log('📤 发起测试POST请求...');
          const response = await fetch(BACKEND_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'test', message: 'post_test' }),
            credentials: 'omit'
          });
          
          const data = await response.json();
          log(`✅ POST测试响应: ${JSON.stringify(data).slice(0, 100)}`);
          dd.device.notification.alert({ message: `POST测试成功: ${data.success}`, title: '测试结果' });
        } catch (error) {
          log(`❌ POST测试失败: ${error.message}`);
          dd.device.notification.alert({ message: `POST测试失败: ${error.message}`, title: '测试结果' });
        } finally {
          btn.disabled = false;
          btn.textContent = '🧪 测试POST连接';
        }
      });
    });
  </script>
</body>
</html>
