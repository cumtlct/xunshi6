<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI è¡¨æ ¼ç»“æ„æŸ¥è¯¢</title>
  <script src="https://g.alicdn.com/dingding/dingtalk-pc-api/2.10.0/index.js"></script>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; padding: 20px; background: #f9f9f9; }
    h2 { color: #1890ff; }
    button { padding: 12px 24px; font-size: 16px; background: #1890ff; color: white; border: none; border-radius: 4px; cursor: pointer; }
    button:disabled { background: #bfbfbf; cursor: not-allowed; }
    #result { margin-top: 20px; }
    .sheet { background: white; margin: 15px 0; padding: 15px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .sheet h4 { margin-top: 0; color: #333; }
    .field { padding: 6px 0; font-size: 14px; color: #595959; }
    .error { color: red; background: #fff2f0; padding: 10px; border-radius: 4px; }
  </style>
</head>
<body>
  <h2>ğŸ” é’‰é’‰ AI è¡¨æ ¼ç»“æ„æŸ¥è¯¢</h2>
  <button id="btnQuery">æŸ¥è¯¢è¡¨ä¸å­—æ®µ</button>
  <div id="result"></div>

  <script>
    // === é…ç½®ä½ çš„åç«¯ API åœ°å€ ===
    const BACKEND_API = "https://get-config-nltlezcizh.cn-hangzhou.fcapp.run"; // ğŸ‘ˆ æ›¿æ¢ä¸ºä½ çš„å‡½æ•°è®¡ç®—è§¦å‘å™¨ URL

    // è‡ªåŠ¨è·å–å½“å‰é¡µé¢ URLï¼ˆç”¨äº JSAPI ç­¾åï¼‰
    const currentUrl = encodeURIComponent(location.href.split("#")[0]);

    // åˆå§‹åŒ–é’‰é’‰ JSAPI
    (async () => {
      try {
        // è°ƒç”¨åç«¯ /jsapi æ¥å£ï¼ˆä½¿ç”¨ fetch + CORSï¼‰
        const res = await fetch(`${BACKEND_API}/jsapi?url=${currentUrl}`);
        const config = await res.json();

        dd.config({
          agentId: config.agentId,
          corpId: config.corpId,
          timeStamp: config.timeStamp,
          nonceStr: config.nonceStr,
          signature: config.signature,
          jsApiList: ["runtime.info"],
          onSuccess: () => console.log("DingTalk JSAPI åˆå§‹åŒ–æˆåŠŸ"),
          onFail: (err) => {
            console.error("dd.config å¤±è´¥:", err);
            alert("JSAPI åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯é…ç½®");
          }
        });
      } catch (err) {
        console.error("JSAPI åˆå§‹åŒ–å¼‚å¸¸:", err);
        alert("æ— æ³•åˆå§‹åŒ–é’‰é’‰ JSAPIï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–åç«¯æœåŠ¡");
      }
    })();

    // æŸ¥è¯¢æŒ‰é’®
    document.getElementById("btnQuery").addEventListener("click", async () => {
      const btn = document.getElementById("btnQuery");
      const resultDiv = document.getElementById("result");
      btn.disabled = true;
      btn.textContent = "æŸ¥è¯¢ä¸­...";
      resultDiv.innerHTML = "";

      try {
        const res = await fetch(`${BACKEND_API}/list-sheets?_t=${Date.now()}`);
        const data = await res.json();
        if (!data.success) throw new Error(data.error || "æœªçŸ¥é”™è¯¯");

        if (data.data.length === 0) {
          resultDiv.innerHTML = '<div class="error">æœªæ‰¾åˆ°ä»»ä½•æ•°æ®è¡¨</div>';
          return;
        }

        let html = "<h3>ğŸ“Š æŸ¥è¯¢ç»“æœï¼š</h3>";
        data.data.forEach(sheet => {
          html += `<div class="sheet"><h4>è¡¨åç§°ï¼š${escapeHtml(sheet.sheetName)} ï¼ˆID: ${escapeHtml(sheet.sheetId)}ï¼‰</h4><div>`;
          if (sheet.fields.length === 0) {
            html += '<div class="field">âš ï¸ æ— å­—æ®µ</div>';
          } else {
            sheet.fields.forEach(field => {
              html += `<div class="field">â€¢ å­—æ®µåï¼š"<strong>${escapeHtml(field.name)}</strong>" | å­—æ®µIDï¼š${escapeHtml(field.fieldId)} | ç±»å‹ï¼š${escapeHtml(field.type || "unknown")}</div>`;
            });
          }
          html += "</div></div>";
        });
        resultDiv.innerHTML = html;
      } catch (err) {
        console.error("æŸ¥è¯¢å¤±è´¥:", err);
        resultDiv.innerHTML = `<div class="error">âŒ æŸ¥è¯¢å¤±è´¥ï¼š${escapeHtml(err.message)}</div>`;
      } finally {
        btn.disabled = false;
        btn.textContent = "æŸ¥è¯¢è¡¨ä¸å­—æ®µ";
      }
    });

    function escapeHtml(text) {
      if (typeof text !== "string") return String(text);
      return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
    }
  </script>
</body>
</html>
