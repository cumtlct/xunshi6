<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>äºŒç»´ç æ‰«æ & AIè¡¨æ ¼å†™å…¥</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.5;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #1890ff;
            margin-bottom: 20px;
        }
        .status-card {
            margin: 20px 0;
            padding: 15px;
            background: #f9f9f9;
            border-left: 4px solid #1890ff;
            border-radius: 6px;
        }
        .status-card.success {
            border-left-color: #52c41a;
            background: #f6ffed;
        }
        button {
            display: block;
            width: 100%;
            padding: 14px;
            font-size: 18px;
            background: #1890ff;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin: 10px 0;
        }
        button.success {
            background: #52c41a;
        }
        .log {
            margin-top: 20px;
            padding: 15px;
            background: #f0f0f0;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            border-radius: 6px;
            max-height: 300px;
            overflow-y: auto;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>äºŒç»´ç æ‰«æ & AIè¡¨æ ¼å†™å…¥</h1>
        <div class="status-card success">
            âœ… é’‰é’‰ç¯å¢ƒæ£€æµ‹æ­£å¸¸<br>
            âœ… æ‰«ç åŠŸèƒ½å·²éªŒè¯æ­£å¸¸<br>
            ğŸ”„ ä½¿ç”¨JSONPè·å–é…ç½®ï¼ŒCORSå†™å…¥æ•°æ®
        </div>
        <div>
            <button id="scanBtn">ğŸ“· æ‰«æäºŒç»´ç </button>
            <div id="scanResult" class="status-card" style="display:none;">
                <!-- æ‰«ç ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ -->
            </div>
        </div>
        <div>
            <button id="writeTableBtn" disabled class="success">ğŸ“Š å†™å…¥ AI è¡¨æ ¼</button>
        </div>
        <div>
            <button id="testJsonpBtn" style="background: #722ed1;">ğŸ§ª JSONPæµ‹è¯•åç«¯</button>
        </div>
        <div>
            <div><strong>æ“ä½œæ—¥å¿—</strong></div>
            <div class="log" id="log"></div>
        </div>
    </div>

    <script src="https://g.alicdn.com/dingding/dingtalk-jsapi/2.13.42/dingtalk.open.js"></script>
    <script>
        // å·¥å…·å‡½æ•°
        function log(msg) {
            const logEl = document.getElementById('log');
            const line = `[${new Date().toLocaleTimeString()}] ${msg}`;
            logEl.textContent += line + '\n';
            logEl.scrollTop = logEl.scrollHeight;
            console.log(line);
        }

        let scanData = null;

        // JSONPæ–¹å¼è°ƒç”¨åç«¯è·å–é…ç½®
        function callBackendWithJsonp() {
            return new Promise((resolve, reject) => {
                const callbackName = `jsonp_callback_${Date.now()}`;
                const url = `https://xunshi-jsslusovkd.cn-hangzhou.fcapp.run?url=${encodeURIComponent(window.location.href)}&callback=${callbackName}`;
                log(`ğŸ“¤ JSONPè¯·æ±‚: ${url}`);
                
                // åˆ›å»ºscriptæ ‡ç­¾
                const script = document.createElement('script');
                script.src = url;
                
                // è®¾ç½®è¶…æ—¶
                const timeoutId = setTimeout(() => {
                    reject(new Error('JSONPè¯·æ±‚è¶…æ—¶'));
                    document.head.removeChild(script);
                    delete window[callbackName];
                }, 10000);
                
                // å®šä¹‰å›è°ƒå‡½æ•°
                window[callbackName] = function(data) {
                    clearTimeout(timeoutId);
                    document.head.removeChild(script);
                    delete window[callbackName];
                    resolve(data);
                };
                
                // é”™è¯¯å¤„ç†
                script.onerror = function() {
                    clearTimeout(timeoutId);
                    document.head.removeChild(script);
                    delete window[callbackName];
                    reject(new Error('JSONPè¯·æ±‚å¤±è´¥'));
                };
                
                document.head.appendChild(script);
            });
        }

        // é€šè¿‡CORS POSTè¯·æ±‚å†™å…¥AIè¡¨æ ¼
        async function writeToAiTable(tableData) {
            try {
                const response = await fetch('https://xunshi-jsslusovkd.cn-hangzhou.fcapp.run', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ tableData: tableData })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error('Fetch error:', error);
                throw error;
            }
        }

        // åˆå§‹åŒ–é’‰é’‰é…ç½®
        async function initDingtalkConfig() {
            log('ğŸ”„ å¼€å§‹åˆå§‹åŒ–é’‰é’‰é…ç½®...');
            try {
                const config = await callBackendWithJsonp();
                log(`âœ… é’‰é’‰é…ç½®è·å–æˆåŠŸ: agentId=${config.agentId}, corpId=${config.corpId}`);
                
                dd.config({
                    agentId: config.agentId,
                    corpId: config.corpId,
                    timeStamp: config.timeStamp,
                    nonceStr: config.nonceStr,
                    signature: config.signature,
                    jsApiList: [
                        'biz.util.scan',
                        'device.notification.alert',
                        'device.notification.confirm',
                        'device.notification.prompt',
                        'biz.ding.create',
                        'biz.util.uploadImage',
                        'biz.util.openLink'
                    ]
                });
                
                dd.ready(() => {
                    log('âœ… é’‰é’‰JSAPIåˆå§‹åŒ–æˆåŠŸ');
                    document.getElementById('scanBtn').disabled = false;
                });
                
                dd.error((err) => {
                    log(`âŒ é’‰é’‰JSAPIåˆå§‹åŒ–å¤±è´¥: ${JSON.stringify(err)}`);
                    alert('é’‰é’‰JSAPIåˆå§‹åŒ–å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®');
                });
            } catch (error) {
                log(`âŒ åˆå§‹åŒ–é’‰é’‰é…ç½®å¤±è´¥: ${error.message}`);
                alert('è·å–é’‰é’‰é…ç½®å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            }
        }

        // é¡µé¢åŠ è½½
        document.addEventListener('DOMContentLoaded', function() {
            log('ğŸ“„ é¡µé¢åŠ è½½å®Œæˆ');
            setTimeout(initDingtalkConfig, 500);
        });

        // JSONPæµ‹è¯•æŒ‰é’®
        document.getElementById('testJsonpBtn').addEventListener('click', async function() {
            log('ğŸ§ª å¼€å§‹JSONPæµ‹è¯•åç«¯');
            try {
                const data = await callBackendWithJsonp();
                log(`âœ… JSONPæµ‹è¯•æˆåŠŸ: ${JSON.stringify(data)}`);
                alert('âœ… åç«¯è¿æ¥æˆåŠŸï¼');
            } catch (error) {
                log(`âŒ JSONPæµ‹è¯•å¤±è´¥: ${error.message}`);
                alert('âŒ åç«¯è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ');
            }
        });

        // æ‰«ææŒ‰é’®äº‹ä»¶
        document.getElementById('scanBtn').addEventListener('click', function() {
            log('ğŸ“² ç”¨æˆ·ç‚¹å‡»"æ‰«æäºŒç»´ç "');
            dd.biz.util.scan({
                type: "qrCode",
                onSuccess: function(data) {
                    log('âœ… æ‰«ç æˆåŠŸ: ' + data.text);
                    scanData = data.text;
                    const resultEl = document.getElementById('scanResult');
                    resultEl.innerHTML = `<strong>æ‰«ç ç»“æœï¼š</strong> ${data.text}`;
                    resultEl.style.display = 'block';
                    document.getElementById('writeTableBtn').disabled = false;
                },
                onFail: function(err) {
                    log('âŒ æ‰«ç å¤±è´¥: ' + JSON.stringify(err));
                    alert('æ‰«ç å¤±è´¥ï¼Œè¯·é‡è¯•');
                }
            });
        });

        // å†™å…¥è¡¨æ ¼æŒ‰é’®äº‹ä»¶
        document.getElementById('writeTableBtn').addEventListener('click', async function() {
            if (!scanData) {
                alert('è¯·å…ˆæ‰«æäºŒç»´ç ï¼');
                return;
            }
            
            const button = this;
            const originalText = button.textContent;
            button.disabled = true;
            button.textContent = 'â³ å†™å…¥ä¸­...';
            log('ğŸ“¤ å‡†å¤‡å†™å…¥æ•°æ®: ' + scanData);
            
            try {
                const tableData = {
                    scanContent: scanData,
                    scanDate: new Date().toLocaleDateString(),
                    scanTime: new Date().toLocaleTimeString(),
                    scanDateTime: new Date().toISOString(),
                    operator: 'é’‰é’‰ç”¨æˆ·',
                    deviceInfo: navigator.userAgent
                };
                
                const result = await writeToAiTable(tableData);
                log('âœ… æ•°æ®å†™å…¥å®Œæˆ: ' + JSON.stringify(result));
                button.textContent = 'âœ… å·²å†™å…¥';
                button.style.background = '#52c41a';
                
                setTimeout(() => {
                    button.textContent = originalText;
                    button.disabled = false;
                    button.style.background = '';
                }, 3000);
            } catch (error) {
                log('âŒ å†™å…¥å¤±è´¥: ' + error.message);
                button.disabled = false;
                button.textContent = originalText;
                alert('å†™å…¥å¤±è´¥: ' + error.message);
            }
        });
    </script>
</body>
</html>
